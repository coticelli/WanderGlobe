@page
@model DreamMapModel
@{
    ViewData["Title"] = "La Mappa dei Tuoi Sogni";
}
@{
    // Questo è necessario per far funzionare le chiamate AJAX ai handler
}
@Html.AntiForgeryToken()

<script>
    // Aggiungi questa funzione globale per ottenere il token
    function getAntiForgeryToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }
</script>

<!-- resto del contenuto HTML -->
<div class="dreammap-container">
    <div class="dreammap-sidebar">
        <div class="dreammap-header">
            <h2><i class="far fa-star"></i> I Tuoi Sogni di Viaggio</h2>
            <p>Pianifica e visualizza le tue future destinazioni</p>
        </div>
        <ul class="nav nav-tabs mb-3" id="dreamTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist" type="button" role="tab">
                    <i class="fas fa-heart"></i> Wishlist
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="planning-tab" data-bs-toggle="tab" data-bs-target="#planning" type="button" role="tab">
                    <i class="fas fa-calendar-alt"></i> In Pianificazione
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover" type="button" role="tab">
                    <i class="fas fa-compass"></i> Scopri
                </button>
            </li>
        </ul>

        <div class="tab-content" id="dreamTabsContent">
            <!-- TAB WISHLIST -->
            <div class="tab-pane fade show active" id="wishlist" role="tabpanel">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <div class="search-container mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="Cerca nei tuoi desideri..." id="wishlistSearch">
                    </div>
                </div>

                <div class="dreammap-list" id="wishlistItems">
                    @foreach (var dream in Model.Wishlist)
                    {
                        <div class="dream-item" data-city="@dream.CityName.ToLower()" data-country="@dream.CountryName.ToLower()"
                         data-id="@dream.Id" data-lat="@dream.Latitude" data-lng="@dream.Longitude"
                         onclick="flyToDestination(@dream.Latitude, @dream.Longitude)">
                            <div class="dream-item-image">
                                <img src="@dream.ImageUrl" alt="@dream.CityName">
                                <div class="dream-flag">
                                    <img src="/images/flags/@(dream.CountryCode.ToLower()).png" alt="@dream.CountryName">
                                </div>
                            </div>
                            <div class="dream-item-content">
                                <div class="dream-priority @dream.Priority.ToString().ToLower()">
                                    @for (int i = 0; i < (int)dream.Priority; i++)
                                    {
                                        <i class="fas fa-star"></i>
                                    }
                                </div>
                                <h3 class="dream-name">@dream.CityName</h3>
                                <p class="dream-country">@dream.CountryName</p>
                                <div class="dream-tags">
                                    @foreach (var tag in dream.Tags)
                                    {
                                        <span class="dream-tag">@tag</span>
                                    }
                                </div>
                                <div class="dream-note">@(dream.Note?.Length > 100 ? dream.Note.Substring(0, 100) + "..." : dream.Note)</div>
                            </div>                            <div class="dream-item-actions">
                                <!-- MODIFICATO: Aggiunta classe show-details-btn e data-id -->
                                <button type="button" class="btn btn-sm btn-outline-info show-details-btn" data-id="@dream.Id">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="moveToPlanningPhase('@dream.Id')">
                                    <i class="fas fa-calendar-plus"></i>
                                </button>
                                <form method="post" asp-page-handler="MarkAsVisited" class="d-inline-block">
                                    <input type="hidden" name="destinationId" value="@dream.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-success" title="Segna come visitata">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                </form>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDream('@dream.Id')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    }

                    @if (!Model.Wishlist.Any())
                    {
                        <div class="empty-state">
                            <img src="/images/empty-wishlist.svg" alt="Wishlist vuota" class="empty-state-icon">
                            <p>La tua lista dei desideri è vuota</p>
                            <p class="text-muted">Aggiungi le destinazioni dei tuoi sogni con il pulsante qui sotto</p>
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-primary add-dream-btn" data-bs-toggle="modal" data-bs-target="#addDreamModal">
                    <i class="fas fa-plus"></i> Aggiungi Destinazione
                </button>
            </div>

            <!-- TAB IN PIANIFICAZIONE -->
            <div class="tab-pane fade" id="planning" role="tabpanel">
                <div class="search-container mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="Cerca nei viaggi pianificati..." id="planningSearch">
                    </div>
                </div>

                <div class="dreammap-list" id="planningItems">
                    @foreach (var plan in Model.PlannedTrips)
                    {
                        <div class="plan-item" data-city="@plan.CityName.ToLower()" data-country="@plan.CountryName.ToLower()"
                         data-id="@plan.Id" data-lat="@plan.Latitude" data-lng="@plan.Longitude"
                         onclick="flyToDestination(@plan.Latitude, @plan.Longitude)">
                            <div class="plan-item-image">
                                <img src="@plan.ImageUrl" alt="@plan.CityName">
                                <div class="plan-flag">
                                    <img src="/images/flags/@(plan.CountryCode.ToLower()).png" alt="@plan.CountryName">
                                </div>
                                <div class="plan-dates">
                                    <div class="plan-date-icon"><i class="fas fa-plane-departure"></i></div>
                                    <div class="plan-date-range">@plan.StartDate.ToString("dd/MM/yyyy")</div>
                                </div>
                            </div>
                            <div class="plan-item-content">
                                <h3 class="plan-name">@plan.CityName</h3>
                                <p class="plan-country">@plan.CountryName</p>
                                <div class="plan-countdown">
                                    <i class="far fa-calendar-alt"></i>
                                    <strong>@((plan.StartDate - DateTime.Today).Days)</strong>
                                    giorni rimanenti
                                </div>
                                <div class="plan-progress">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar"
                                         style="width: @plan.CompletionPercentage%"
                                         aria-valuenow="@plan.CompletionPercentage"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span class="plan-progress-text">@plan.CompletionPercentage% completato</span>
                                </div>
                                <ul class="plan-checklist">
                                    @foreach (var item in plan.Checklist.Take(3))
                                    {
                                        <li class="@(item.IsCompleted ? "completed" : "")">
                                            <i class="@(item.IsCompleted ? "fas fa-check-circle" : "far fa-circle")"></i>
                                            @item.Title
                                        </li>
                                    }
                                    @if (plan.Checklist.Count > 3)
                                    {
                                        <li class="more">+ altri @(plan.Checklist.Count - 3) elementi</li>
                                    }
                                </ul>
                            </div>
                            <div class="plan-item-actions">
                                <!-- MODIFICATO: Aggiunta classe show-details-btn e data-id -->
                                <button type="button" class="btn btn-sm btn-outline-info show-details-btn" data-id="@plan.Id">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="markAsVisited('@plan.Id')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePlan('@plan.Id')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    }

                    @if (!Model.PlannedTrips.Any())
                    {
                        <div class="empty-state">
                            <img src="/images/empty-planning.svg" alt="Nessun viaggio pianificato" class="empty-state-icon">
                            <p>Non hai ancora pianificato viaggi</p>
                            <p class="text-muted">Sposta un sogno dalla tua wishlist qui per iniziare a pianificarlo</p>
                        </div>
                    }
                </div>
            </div>

            <!-- TAB SCOPRI -->
            <div class="tab-pane fade" id="discover" role="tabpanel">
                <div class="discover-header">
                    <h3>Destinazioni consigliate per te</h3>
                    <p>Basate sui tuoi interessi e destinazioni visitate</p>
                </div>

                <div class="recommendation-filters">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="recommendationType" id="recType1" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="recType1">Tutte</label>

                        <input type="radio" class="btn-check" name="recommendationType" id="recType2" autocomplete="off">
                        <label class="btn btn-outline-primary" for="recType2">Simili</label>

                        <input type="radio" class="btn-check" name="recommendationType" id="recType3" autocomplete="off">
                        <label class="btn btn-outline-primary" for="recType3">Popolari</label>

                        <input type="radio" class="btn-check" name="recommendationType" id="recType4" autocomplete="off">
                        <label class="btn btn-outline-primary" for="recType4">Nuove</label>
                    </div>
                </div>
                <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken().ToString()">
                <div class="discover-grid">
                    @foreach (var recommendation in Model.Recommendations)
                    {
                        <div class="discover-card" data-lat="@recommendation.Latitude" data-lng="@recommendation.Longitude">
                            <div class="discover-image">
                                <img src="@recommendation.ImageUrl" alt="@recommendation.CityName">
                                <div class="discover-flag">
                                    <img src="/images/flags/@(recommendation.CountryCode.ToLower()).png" alt="@recommendation.CountryName">
                                </div>
                                <div class="discover-match">
                                    <span>@recommendation.MatchPercentage%</span>
                                    <small>Match</small>
                                </div>
                            </div>
                            <div class="discover-content">
                                <h4>@recommendation.CityName</h4>
                                <p>@recommendation.CountryName</p>
                                <div class="discover-tags">
                                    @foreach (var tag in recommendation.Tags.Take(3))
                                    {
                                        <span class="discover-tag">@tag</span>
                                    }
                                </div>
                                <div class="discover-highlights">
                                    <div class="discover-highlight">
                                        <i class="fas fa-temperature-high"></i> @recommendation.Weather
                                    </div>
                                    <div class="discover-highlight">
                                        <i class="fas fa-euro-sign"></i> @recommendation.CostLevel
                                    </div>
                                    <div class="discover-highlight">
                                        <i class="fas fa-hotel"></i> @recommendation.Accommodations
                                    </div>
                                </div>
                            </div>
                            <div class="discover-actions">
                                <button class="btn btn-sm btn-outline-info" onclick="flyToDestination(@recommendation.Latitude, @recommendation.Longitude)">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                                <button class="btn btn-primary" onclick="addToWishlist('@recommendation.Id')">
                                    <i class="fas fa-heart"></i> Aggiungi
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <div class="discover-more">
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> Carica altri suggerimenti
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="dreamMap" class="dreammap-main">
        <!-- La mappa sarà renderizzata qui -->
    </div>
</div>

<!-- Modal per aggiungere un nuovo sogno - AGGIORNATO con dropdown città -->
<div class="modal fade" id="addDreamModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi una nuova destinazione dei sogni</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-page-handler="SaveToWishlist" enctype="multipart/form-data" id="dreamForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="WishlistForm_City" class="form-label">Città</label>
                                <!-- Make sure this is correctly structured in your modal form -->                                <select class="form-select" id="WishlistForm_City" name="WishlistForm.City" required>
                                    <option value="">Seleziona una città</option>
                                    @if (Model.WishlistForm.AvailableCities != null && Model.WishlistForm.AvailableCities.Any())
                                    {
                                        @foreach (var city in Model.WishlistForm.AvailableCities)
                                        {
                                            <option value="@city.Name"
                                            data-country="@city.Country"
                                            data-country-code="@city.CountryCode">
                                                @city.Name (@city.Country)
                                            </option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="" disabled>Nessuna città disponibile - Ricarica la pagina</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="WishlistForm_Country" class="form-label">Paese</label>
                                <input type="text" class="form-control" id="WishlistForm_Country" name="WishlistForm.Country" readonly>
                                <input type="hidden" name="Country" id="Country" />
                                <input type="hidden" name="CountryCode" id="CountryCode" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Priorità</label>
                                <div class="priority-selector">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="WishlistForm.Priority" id="priorityLow" value="Bassa">
                                        <label class="form-check-label" for="priorityLow">
                                            <i class="fas fa-star"></i>
                                            <span>Bassa</span>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="WishlistForm.Priority" id="priorityMedium" value="Media" checked>
                                        <label class="form-check-label" for="priorityMedium">
                                            <i class="fas fa-star"></i><i class="fas fa-star"></i>
                                            <span>Media</span>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="WishlistForm.Priority" id="priorityHigh" value="Alta">
                                        <label class="form-check-label" for="priorityHigh">
                                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                            <span>Alta</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="WishlistForm_Tags" class="form-label">Tag</label>
                                <input type="text" class="form-control" id="WishlistForm_Tags" name="WishlistForm.Tags"
                                       placeholder="es: spiagge, montagna, cultura (separati da virgola)">
                                <div class="form-text">Aggiungi tag per categorizzare il tuo sogno</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Immagine della destinazione</label>
                                <div class="destination-image-preview">
                                    <img src="/images/placeholder-destination.jpg" id="destinationImagePreview" alt="Anteprima immagine">
                                    <div class="image-overlay">
                                        <input type="file" id="WishlistForm_ImageFile" name="WishlistForm.ImageFile" class="d-none" accept="image/*">
                                        <button type="button" class="btn btn-light btn-sm" id="selectImageBtn">
                                            <i class="fas fa-camera"></i> Scegli immagine
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="WishlistForm_Notes" class="form-label">Note</label>
                                <textarea class="form-control" id="WishlistForm_Notes" name="WishlistForm.Notes" rows="5"
                                          placeholder="Scrivi qui i motivi per cui vuoi visitare questa destinazione"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-heart me-1"></i> Salva nella Wishlist
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal per dettagli di un sogno -->
<div class="modal fade" id="dreamDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header dream-details-header">
                <h5 class="modal-title">Dettagli Destinazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="dream-details-banner">
                    <img src="" id="detailsBannerImg" alt="Immagine destinazione">
                    <div class="dream-details-overlay">
                        <h2 id="detailsCityName"></h2>
                        <p id="detailsCountryName"></p>
                    </div>
                </div>
                <div class="dream-details-content">
                    <div class="dream-details-info">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="detail-text">
                                <h6>Priorità</h6>
                                <div class="dream-priority" id="detailsPriority"></div>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="detail-text">
                                <h6>Tag</h6>
                                <div id="detailsTags" class="dream-tags"></div>
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="detail-text">
                                <h6>Aggiunto il</h6>
                                <p id="detailsDate"></p>
                            </div>
                        </div>

                        <div class="detail-item full-width">
                            <div class="detail-icon">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <div class="detail-text">
                                <h6>Note</h6>
                                <div class="dream-note" id="detailsNote"></div>
                            </div>
                        </div>
                    </div>

                    <div class="dream-ai-suggestions">
                        <h5><i class="fas fa-lightbulb"></i> Informazioni sulla destinazione</h5>
                        <div class="suggestion-tabs">
                            <div class="suggestion-tab" data-tab="attractions">
                                <i class="fas fa-camera"></i> Attrazioni
                            </div>
                            <div class="suggestion-tab" data-tab="gastronomy">
                                <i class="fas fa-utensils"></i> Gastronomia
                            </div>
                            <div class="suggestion-tab" data-tab="history">
                                <i class="fas fa-landmark"></i> Storia
                            </div>
                            <div class="suggestion-tab" data-tab="tips">
                                <i class="fas fa-info-circle"></i> Consigli
                            </div>
                        </div>

                        <div class="suggestion-content">
                            <div class="suggestion-pane" data-pane="attractions" id="suggestionsAttractions">
                                <!-- Contenuto generato dinamicamente -->
                            </div>
                            <div class="suggestion-pane" data-pane="gastronomy" id="suggestionsGastronomy">
                                <!-- Contenuto generato dinamicamente -->
                            </div>
                            <div class="suggestion-pane" data-pane="history" id="suggestionsHistory">
                                <!-- Contenuto generato dinamicamente -->
                            </div>
                            <div class="suggestion-pane" data-pane="tips" id="suggestionsTips">
                                <!-- Contenuto generato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-warning" id="planTripBtn">
                    <i class="fas fa-calendar-plus me-1"></i> Pianifica Viaggio
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Modal per dettagli di un viaggio pianificato -->
<div class="modal fade" id="planDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header plan-details-header">
                <h5 class="modal-title"><i class="fas fa-plane"></i> Il Tuo Viaggio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="plan-details-banner">
                    <img src="" id="planBannerImg" alt="Immagine destinazione">
                    <div class="plan-details-overlay">
                        <div class="plan-details-info">
                            <h2 id="planCityName"></h2>
                            <p id="planCountryName"></p>
                            <div class="plan-date-range" id="planDateRange">
                                <i class="fas fa-calendar-alt"></i> <span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- plan-details-content INIZIA QUI -->
                <div class="plan-details-content">
                    <div class="row">
                        <div class="col-md-7">
                            <!-- SEZIONE DATE SPOSTATA QUI (POSIZIONE CORRETTA) -->
                            <div class="plan-details-section">
                                <h5><i class="fas fa-calendar-days"></i> Date del Viaggio</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="planStartDateInput" class="form-label">Data Inizio</label>
                                        <input type="date" class="form-control" id="planStartDateInput">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="planEndDateInput" class="form-label">Data Fine</label>
                                        <input type="date" class="form-control" id="planEndDateInput">
                                    </div>
                                </div>
                            </div>
                            <!-- FINE SEZIONE DATE -->

                            <div class="plan-details-section">
                                <h5><i class="fas fa-list-check"></i> Pianificazione del Viaggio</h5>
                                <div class="plan-progress-bar">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" id="planProgressBar"
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <span class="progress-text">Completato: <span id="progressPercentage">0</span>%</span>
                                </div>

                                <div class="plan-checklist-container">
                                    <div class="checklist-header">
                                        <h6>Lista di controllo</h6>
                                        <button class="btn btn-sm btn-outline-primary" id="addChecklistItem">
                                            <i class="fas fa-plus"></i> Aggiungi elemento
                                        </button>
                                    </div>
                                    <ul class="plan-detailed-checklist" id="planChecklist">
                                        <!-- Elementi della checklist generati dinamicamente -->
                                    </ul>
                                </div>
                            </div>

                            <div class="plan-details-section">
                                <h5><i class="fas fa-sticky-note"></i> Note di Viaggio</h5>
                                <div class="plan-notes-container">
                                    <div class="form-floating">
                                        <textarea class="form-control" placeholder="Scrivi qui le tue note di viaggio"
                                                  id="planNotes" style="height: 150px"></textarea>
                                        <label for="planNotes">Appunti e dettagli del viaggio</label>
                                    </div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-primary btn-sm" id="saveNotesBtn">
                                            <i class="fas fa-save"></i> Salva note
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <!-- ... Colonna destra del modal (Informazioni Utili, Esplora) ... -->
                            <div class="plan-details-section">
                                <h5><i class="fas fa-info-circle"></i> Informazioni Utili</h5>
                                <div class="info-cards">
                                    <div class="info-card" id="weatherCard">
                                        <div class="info-card-title">
                                            <i class="fas fa-cloud-sun"></i> Meteo
                                        </div>
                                        <div class="info-card-content">
                                            <div class="weather-info">
                                                <div class="weather-icon">
                                                    <i class="fas fa-sun"></i>
                                                </div>
                                                <div class="weather-details">
                                                    <div class="weather-temp">22°C - 28°C</div>
                                                    <div class="weather-desc">Soleggiato</div>
                                                </div>
                                            </div>
                                            <div class="weather-forecast">
                                                Media di stagione per il periodo selezionato.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="info-card" id="currencyCard">
                                        <div class="info-card-title">
                                            <i class="fas fa-money-bill-wave"></i> Valuta
                                        </div>
                                        <div class="info-card-content" id="currencyInfo">
                                            <!-- Contenuto generato dinamicamente -->
                                        </div>
                                    </div>

                                    <div class="info-card" id="languageCard">
                                        <div class="info-card-title">
                                            <i class="fas fa-language"></i> Lingua
                                        </div>
                                        <div class="info-card-content" id="languageInfo">
                                            <!-- Contenuto generato dinamicamente -->
                                        </div>
                                    </div>

                                    <div class="info-card" id="timeCard">
                                        <div class="info-card-title">
                                            <i class="fas fa-clock"></i> Fuso Orario
                                        </div>
                                        <div class="info-card-content" id="timeInfo">
                                            <!-- Contenuto generato dinamicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="plan-details-section">
                                <h5><i class="fas fa-map-marked-alt"></i> Esplora</h5>
                                <div class="explore-buttons">
                                    <a href="#" class="btn btn-outline-primary external-link" id="googleMapsBtn" data-type="maps">
                                        <i class="fas fa-map"></i> Google Maps
                                    </a>
                                    <a href="#" class="btn btn-outline-primary external-link" id="bookingBtn" data-type="booking">
                                        <i class="fas fa-hotel"></i> Booking.com
                                    </a>
                                    <a href="#" class="btn btn-outline-primary external-link" id="tripAdvisorBtn" data-type="tripadvisor">
                                        <i class="fas fa-thumbs-up"></i> TripAdvisor
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- plan-details-content FINE QUI -->
            </div>
            <div class="modal-footer">
                <div>
                    <button type="button" class="btn btn-danger" id="removePlanBtn">
                        <i class="fas fa-trash-alt"></i> Elimina Piano
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="updatePlanBtn">
                        <i class="fas fa-save"></i> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-success" id="markVisitedBtn">
                        <i class="fas fa-check"></i> Segna come Visitato
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Dettagli/Ricordi di una Città Visitata -->
<div class="modal fade" id="visitDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--accent-color); color: white;">
                <h5 class="modal-title"><i class="fas fa-mountain-city me-2"></i>Ricordi di Viaggio</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="visit-details-banner">
                    <img src="/images/placeholder-destination.jpg" id="visitBannerImg" alt="Immagine destinazione visitata">
                    <div class="visit-details-overlay">
                        <h2 id="visitCityName">Nome Città</h2>
                        <p id="visitCountryName">Nome Paese</p>
                    </div>
                </div>
                <div class="visit-details-content p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visitDateInput" class="form-label"><i class="fas fa-calendar-check me-1"></i> Data della Visita</label>
                                <input type="date" class="form-control" id="visitDateInput">
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-star me-1"></i> Valutazione</label>
                                <div id="visitRatingStars" class="rating-stars">
                                    <i class="far fa-star" data-value="1"></i>
                                    <i class="far fa-star" data-value="2"></i>
                                    <i class="far fa-star" data-value="3"></i>
                                    <i class="far fa-star" data-value="4"></i>
                                    <i class="far fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" id="visitRatingInput" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="visitHighlightsInput" class="form-label"><i class="fas fa-bullseye me-1"></i> Momenti Salienti (separati da virgola)</label>
                                <input type="text" class="form-control" id="visitHighlightsInput" placeholder="Es: Vista mozzafiato, Cena deliziosa">
                            </div>
                            <div class="mb-3">
                                <label for="visitCompanionsInput" class="form-label"><i class="fas fa-users me-1"></i> Compagni di Viaggio (separati da virgola)</label>
                                <input type="text" class="form-control" id="visitCompanionsInput" placeholder="Es: Maria, Famiglia">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="visitMemoriesTextarea" class="form-label"><i class="fas fa-book-open me-1"></i> I Miei Ricordi</label>
                        <textarea class="form-control" id="visitMemoriesTextarea" rows="6" placeholder="Scrivi qui le tue esperienze, aneddoti e sensazioni..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-images me-1"></i> Galleria Foto</label>
                        <div id="visitPhotoGallery" class="visit-photo-gallery">
                            <!-- Le foto verranno aggiunte qui dinamicamente -->
                            <p class="text-muted">Nessuna foto aggiunta per questa visita.</p>
                        </div>
                        <!-- Funzionalità upload foto (opzionale, per ora non implementata)
                        <div class="mt-2">
                            <input type="file" class="form-control form-control-sm" id="visitPhotoUpload" multiple accept="image/*">
                            <button type="button" class="btn btn-sm btn-outline-primary mt-1" id="uploadVisitPhotosBtn"><i class="fas fa-upload"></i> Carica Foto</button>
                        </div>
                        -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-success" id="saveVisitDetailsBtn"><i class="fas fa-save me-1"></i> Salva Ricordi</button>
            </div>
        </div>
    </div>
</div>

<!-- Form invisibile per aggiungere un nuovo elemento alla checklist -->
<div class="modal fade" id="addChecklistItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi elemento alla checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="checklistItemTitle" class="form-label">Titolo</label>
                    <input type="text" class="form-control" id="checklistItemTitle" placeholder="Es: Prenotare volo">
                </div>
                <div class="mb-3">
                    <label for="checklistItemCategory" class="form-label">Categoria</label>
                    <select class="form-select" id="checklistItemCategory">
                        <option value="travel">Viaggio</option>
                        <option value="accommodation">Alloggio</option>
                        <option value="documents">Documenti</option>
                        <option value="activities">Attività</option>
                        <option value="other">Altro</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="checklistItemDueDate" class="form-label">Data di scadenza (opzionale)</label>
                    <input type="date" class="form-control" id="checklistItemDueDate">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="saveChecklistItemBtn">Aggiungi</button>
            </div>
        </div>
    </div>
</div>

<!-- Inserire dopo la sezione main o dove opportuno nella struttura della pagina -->

<div class="ai-recommendations-section">
    <h2 class="section-title">
        <i class="fas fa-globe-europe me-2"></i>
        Destinazioni consigliate per te
    </h2>
    <p class="section-description">Basate sui tuoi interessi e destinazioni visitate</p>

    <div class="recommendations-tabs">
        <ul class="nav nav-pills" id="recommendationsTabs">
            <li class="nav-item">
                <button class="nav-link active" data-type="tutte">Tutte</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-type="simili">Simili</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-type="popolari">Popolari</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-type="nuove">Nuove</button>
            </li>
        </ul>

        <div class="refresh-recommendations">
            <button id="refreshRecommendationsBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>
                Carica altri suggerimenti
            </button>
        </div>
    </div>

    <!-- Contenitore per le schede delle destinazioni consigliate -->
    <div class="recommendations-container" id="recommendationsContainer">
        <div class="recommendations-loading" id="recommendationsLoading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p>Ricerca destinazioni per te...</p>
        </div>

        <div class="recommendations-grid" id="recommendationsGrid">
            @foreach (var destination in Model.RecommendedDestinations)
            {
                <div class="recommendation-card" data-id="@destination.Id">
                    <div class="recommendation-image">
                        <img src="@destination.ImageUrl" alt="@destination.CityName"
                         onerror="this.src='/images/placeholder-destination.jpg'">
                    </div>
                    <div class="recommendation-content">
                        <h3 class="recommendation-title">@destination.CityName</h3>
                        <h4 class="recommendation-subtitle">@destination.CountryName</h4>
                        <p class="recommendation-description">@destination.Description</p>
                        <div class="recommendation-reason">
                            <i class="fas fa-star me-1"></i>
                            <span>@destination.ReasonToVisit</span>
                        </div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="btn btn-primary add-to-wishlist" data-city="@destination.CityName"
                            data-country="@destination.CountryName" data-lat="@destination.Latitude"
                            data-lng="@destination.Longitude">
                            <i class="fas fa-heart me-1"></i> Aggiungere
                        </button>
                        <button class="btn btn-outline-secondary fly-to-btn" data-lat="@destination.Latitude"
                            data-lng="@destination.Longitude">
                            <i class="fas fa-map-marker-alt me-1"></i> Mostra
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="recommendations-empty" id="recommendationsEmpty" style="display: none;">
            <i class="fas fa-search fa-2x mb-3"></i>
            <h4>Nessun suggerimento disponibile</h4>
            <p>Prova un'altra categoria o aggiorna i suggerimenti</p>
        </div>

        <div class="recommendations-error" id="recommendationsError" style="display: none;">
            <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
            <h4>Errore durante il caricamento dei suggerimenti</h4>
            <p>Si è verificato un problema nel recupero delle destinazioni consigliate</p>
            <button class="btn btn-primary retry-btn">
                <i class="fas fa-redo me-1"></i> Riprova
            </button>
        </div>
    </div>
</div>

<!-- Aggiungiamo lo stile CSS inline (poi sarà preferibile spostarlo in un file CSS) -->
<style>
    .ai-recommendations-section {
        background-color: var(--section-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .recommendations-tabs {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

        .recommendations-tabs .nav-pills {
            border-radius: 50px;
            overflow: hidden;
            background: var(--light-bg);
            padding: 0.25rem;
        }

        .recommendations-tabs .nav-link {
            border-radius: 50px;
            padding: 0.5rem 2rem;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

            .recommendations-tabs .nav-link.active {
                background-color: var(--primary-color);
                color: white;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }

    #refreshRecommendationsBtn {
        background-color: var(--light-bg);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

        #refreshRecommendationsBtn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .recommendation-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
    }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

    .recommendation-image {
        height: 180px;
        overflow: hidden;
        position: relative;
    }

        .recommendation-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

    .recommendation-card:hover .recommendation-image img {
        transform: scale(1.05);
    }

    .recommendation-content {
        padding: 1.25rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .recommendation-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
        color: var(--heading-color);
    }

    .recommendation-subtitle {
        font-size: 1rem;
        color: var(--muted-color);
        margin: 0 0 1rem 0;
    }

    .recommendation-description {
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 0.75rem;
        color: var(--text-color);
        flex-grow: 1;
    }

    .recommendation-reason {
        background-color: var(--light-bg);
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
    }

    .recommendation-actions {
        display: flex;
        gap: 0.5rem;
        padding: 0 1.25rem 1.25rem;
    }

        .recommendation-actions .btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }

    .recommendations-loading,
    .recommendations-empty,
    .recommendations-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1rem;
        text-align: center;
    }

        .recommendations-loading .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }

    @@media (max-width: 768px) {
        .recommendations-tabs {
            flex-direction: column;
            gap: 1rem;
        }

            .recommendations-tabs .nav-pills {
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }

        .recommendation-card {
            max-width: 100%;
        }
    }

    /* Effetto glare sulle card */
    .recommendation-card {
        position: relative;
        overflow: hidden;
    }

        .recommendation-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient( to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100% );
            transform: rotate(30deg);
            pointer-events: none;
            transition: transform 0.6s ease;
            opacity: 0;
        }

        .recommendation-card:hover::after {
            opacity: 1;
            animation: card-glare 1.5s ease-in-out;
        }

    @@keyframes card-glare {
        0% {
            transform: rotate(30deg) translateX(-300%);
        }

        100% {
            transform: rotate(30deg) translateX(300%);
        }
    }

    /* Badge "AI Pick" per suggerimenti generati con AI */
    .recommendation-card .ai-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
</style>




@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-light: rgba(26, 115, 232, 0.1);
            --accent-color: #2ecc71;
            --accent-light: rgba(46, 204, 113, 0.1);
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --muted-color: #6c757d; /* Questo è un grigio visibile su bianco */
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f2f7ff;
            overflow: hidden;
        }

        /* Container principale */
        .dreammap-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 56px); /* Se la navbar è 56px, altrimenti adattare a 64px se è l'altezza della navbar di layout.cshtml */
            overflow: hidden;
        }

        /* Sidebar */
        .dreammap-sidebar {
            background-color: white;
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        .custom-marker-icon {
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            width: 30px;
            height: 30px;
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .ai-error {
            background-color: #fff5f5;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .ai-suggestion-list {
            padding-left: 20px;
        }

            .ai-suggestion-list li {
                margin-bottom: 10px;
            }

        #detailsBannerImg {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .dream-tag {
            display: inline-block;
            background-color: var(--primary-light); /* CORRETTO: --primary-light */
            color: var(--primary-color);
            border-radius: 15px;
            padding: 2px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }


        /* Stili per Visit Details Modal */
        .visit-details-banner { /* Simile a dream-details-banner */
            position: relative;
            height: 200px; /* Un po' meno alto */
        }

            .visit-details-banner img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .visit-details-overlay { /* Simile a dream-details-overlay */
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            padding: 15px 20px;
        }

            .visit-details-overlay h2 {
                margin: 0;
                font-size: 1.8rem;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            }

            .visit-details-overlay p {
                margin: 3px 0 0;
                font-size: 1rem;
                opacity: 0.9;
            }

        .rating-stars {
            font-size: 1.5rem; /* Dimensione delle stelle */
            color: var(--warning-color); /* Colore delle stelle */
            cursor: pointer;
        }

            .rating-stars i:hover {
                transform: scale(1.1);
            }

        .visit-photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: var(--border-radius);
            min-height: 80px;
            align-items: center; /* Centra il testo "Nessuna foto" se presente */
            justify-content: center; /* Centra il testo "Nessuna foto" se presente */
        }

            .visit-photo-gallery img {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .visit-photo-gallery .text-muted {
                width: 100%;
                text-align: center;
            }

        .dreammap-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

            .dreammap-header h2 {
                margin: 0;
                font-size: 1.5rem;
                color: var(--dark-color); /* CORRETTO: --dark-color */
                display: flex;
                align-items: center;
                gap: 8px;
            }

                .dreammap-header h2 i {
                    color: var(--warning-color);
                }

            .dreammap-header p {
                margin: 5px 0 0;
                color: var(--muted-color); /* CORRETTO: --muted-color */
                font-size: 0.9rem;
            }

        /* Nav tabs */
        .nav-tabs {
            padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .dreammap-sidebar .nav-tabs .nav-link { /* Aggiunto .dreammap-sidebar per specificità se necessario, ma il problema è !important */
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--muted-color) !important; /* PRIMA MODIFICA: Aggiunto !important. var(--muted-color) è #6c757d */
            padding: 10px 0; /* Rimosso !important se non strettamente necessario qui, ma il padding non è il problema */
            margin-right: 20px;
            font-weight: 500;
        }

            .dreammap-sidebar .nav-tabs .nav-link.active { /* Aggiunto .dreammap-sidebar per specificità se necessario */
                border-bottom: 2px solid var(--primary-color); /* CORRETTO: --primary-color */
                color: var(--primary-color) !important; /* SECONDA MODIFICA: Aggiunto !important. var(--primary-color) è #1a73e8 */
                background: transparent;
            }

            .dreammap-sidebar .nav-tabs .nav-link i { /* Aggiunto .dreammap-sidebar per specificità se necessario */
                margin-right: 5px;
                /* Il colore dell'icona verrà ereditato dal .nav-link genitore, che ora è corretto */
            }

        /* Tab content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Search container */
        .search-container {
            position: relative;
        }

        /* Dream list */
        .dreammap-list {
            margin-bottom: 20px;
            min-height: 300px;
        }

        /* Dream item */
        .dream-item, .plan-item {
            background: white;
            border-radius: var(--border-radius); /* CORRETTO: --border-radius */
            box-shadow: var(--box-shadow); /* CORRETTO: --box-shadow */
            margin-bottom: 20px;
            overflow: hidden;
            transition: var(--transition); /* CORRETTO: --transition */
        }

            .dream-item:hover, .plan-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 18px rgba(0,0,0,0.15);
                cursor: pointer;
            }

        .dream-item-image, .plan-item-image {
            position: relative;
            height: 120px;
            overflow: hidden;
        }

            .dream-item-image img, .plan-item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }

        .dream-item:hover .dream-item-image img,
        .plan-item:hover .plan-item-image img {
            transform: scale(1.05);
        }

        .dream-flag, .plan-flag {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

            .dream-flag img, .plan-flag img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .dream-item-content, .plan-item-content {
            padding: 15px;
        }

        .dream-priority {
            margin-bottom: 8px;
        }

            .dream-priority.low i { /* Assicurarsi che queste classi esistano o siano applicate correttamente */
                color: #ffb300;
            }

            .dream-priority.medium i {
                color: #fb8c00;
            }

            .dream-priority.high i {
                color: #f57c00;
            }

        .dream-name, .plan-name {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color); /* CORRETTO: --dark-color */
        }

        .dream-country, .plan-country {
            color: var(--muted-color); /* CORRETTO: --muted-color */
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .dream-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .dream-tag { /* Stile già definito sopra, assicurarsi coerenza */
            background-color: var(--primary-light); /* CORRETTO: --primary-light */
            color: var(--primary-color);
            font-size: 0.75rem; /* Leggermente più piccolo qui, unificare se necessario */
            padding: 2px 8px;
            border-radius: 15px;
        }

        .dream-note {
            font-size: 0.9rem;
            color: var(--muted-color); /* CORRETTO: --muted-color */
            line-height: 1.4;
        }

        .dream-item-actions, .plan-item-actions {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* Plan specific */
        .plan-dates {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plan-date-icon {
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plan-countdown {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--warning-color);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .plan-progress {
            margin-bottom: 15px;
        }

            .plan-progress .progress {
                height: 8px;
                border-radius: 4px;
                background-color: var(--light-color); /* CORRETTO: --light-color */
                margin-bottom: 5px;
            }

            .plan-progress .progress-bar {
                background-color: var(--accent-color);
                border-radius: 4px;
            }

        .plan-progress-text {
            font-size: 0.8rem;
            color: var(--muted-color); /* CORRETTO: --muted-color */
        }

        .plan-checklist {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-suggestion-list li strong {
            color: var (--primary-color); /* CORRETTO: --primary-color */
        }

        .plan-checklist li {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
            font-size: 0.9rem;
            color: var(--dark-color); /* CORRETTO: --dark-color */
        }

            .plan-checklist li.completed {
                color: var(--accent-color);
                text-decoration: line-through;
            }

            .plan-checklist li.more {
                color: var (--muted-color); /* CORRETTO: --muted-color */
                font-style: italic;
                text-align: center;
                padding-top: 10px;
            }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-state-icon {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .empty-state p {
            margin-bottom: 5px;
            color: var(--dark-color); /* CORRETTO: --dark-color */
        }

            .empty-state p.text-muted {
                font-size: 0.9rem;
            }

        /* Add dream button */
        .add-dream-btn {
            position: sticky;
            bottom: 0; /* Potrebbe necessitare di un padding-bottom sul .tab-content per non sovrapporsi all'ultimo elemento */
            margin-top: 20px; /* O padding-top sul contenitore del bottone se è fisso in basso */
            width: 100%;
            padding: 12px;
            border-radius: 8px;
        }

        /* Discover tab */
        .discover-header {
            margin-bottom: 20px;
        }

            .discover-header h3 {
                margin: 0;
                font-size: 1.3rem;
                color: var(--dark-color); /* CORRETTO: --dark-color */
            }

            .discover-header p {
                color: var(--muted-color); /* CORRETTO: --muted-color */
                font-size: 0.9rem;
                margin: 5px 0 0;
            }

        .recommendation-filters {
            margin-bottom: 20px;
        }

        .discover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .discover-card {
            background: white;
            border-radius: var(--border-radius); /* CORRETTO: --border-radius */
            overflow: hidden;
            box-shadow: var(--box-shadow); /* CORRETTO: --box-shadow */
            transition: var(--transition); /* CORRETTO: --transition */
        }

            .discover-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            }

        .discover-image {
            position: relative;
            height: 150px;
        }

            .discover-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .discover-flag { /* Stile già presente, assicurarsi coerenza */
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

            .discover-flag img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .discover-match {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
        }

            .discover-match span {
                font-weight: 700;
                font-size: 1rem;
            }

            .discover-match small {
                font-size: 0.7rem;
                opacity: 0.8;
            }

        .discover-content {
            padding: 15px;
        }

            .discover-content h4 {
                margin: 0 0 5px 0;
                font-size: 1.1rem;
            }

            .discover-content p {
                margin: 0 0 10px 0;
                color: var(--muted-color); /* CORRETTO: --muted-color */
                font-size: 0.9rem;
            }

        .discover-tags { /* Stile già presente, assicurarsi coerenza */
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .discover-tag { /* Stile già presente, assicurarsi coerenza */
            background-color: var(--primary-light); /* CORRETTO: --primary-light */
            color: var(--primary-color);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 15px;
        }

        .discover-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .discover-highlight {
            background-color: var(--light-color); /* CORRETTO: --light-color */
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .discover-highlight i {
                color: var(--primary-color);
            }

        .discover-actions {
            padding: 10px 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
        }

        .discover-more {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        /* Map container */
        .dreammap-main {
            position: relative; /* Non dovrebbe essere necessario se height: 100vh non è usato qui e l'altezza è gestita da dreammap-container */
            /* height: 100vh; Rimosso: l'altezza è gestita da grid in .dreammap-container */
        }

        #dreamMap {
            height: 100%; /* Occuperà l'altezza della cella grid in .dreammap-container */
            width: 100%;
        }

        /* Modal styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            overflow: hidden;
        }

        .modal-header {
            background-color: var(--primary-color); /* CORRETTO: --primary-color */
            color: white;
        }

            .modal-header .btn-close {
                filter: brightness(200%);
            }

        /* Add dream modal */
        .priority-selector {
            display: flex;
            gap: 15px;
        }

            .priority-selector .form-check-inline {
                margin-right: 0;
            }

            .priority-selector i {
                color: #ffb300; /* O var(--warning-color) se preferito */
            }

        .destination-image-preview {
            position: relative;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--box-shadow); /* CORRETTO: --box-shadow */
        }

            .destination-image-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* Dream details modal */
        .dream-details-header, .plan-details-header {
            background: linear-gradient(135deg, var(--primary-color), #4c6ef5); /* CORRETTO: --primary-color */
        }

        .dream-details-banner, .plan-details-banner {
            position: relative;
            height: 250px;
        }

            .dream-details-banner img, .plan-details-banner img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .dream-details-overlay, .plan-details-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 20px;
        }

            .dream-details-overlay h2, .plan-details-overlay h2 {
                margin: 0;
                font-size: 2rem;
                text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            }

            .dream-details-overlay p, .plan-details-overlay p {
                margin: 5px 0 0;
                font-size: 1.1rem;
                opacity: 0.9;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            }

        .dream-details-content, .plan-details-content {
            padding: 20px;
        }

        .dream-details-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            display: flex;
            gap: 15px;
            flex: 1 1 calc(33.333% - 20px); /* Per 3 colonne, aggiusta se necessario */
        }

            .detail-item.full-width {
                flex: 1 1 100%;
            }

        .detail-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary-light); /* CORRETTO: --primary-light */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color); /* CORRETTO: --primary-color */
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .detail-text {
            flex: 1;
        }

            .detail-text h6 {
                margin: 0 0 5px 0;
                color: var(--muted-color); /* CORRETTO: --muted-color */
                font-size: 0.9rem;
            }

        .dream-note { /* Stile già definito, assicurarsi coerenza */
            background-color: var(--light-color); /* CORRETTO: --light-color */
            border-radius: 8px;
            padding: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* AI Suggestions */
        .dream-ai-suggestions {
            margin-top: 30px;
        }

            .dream-ai-suggestions h5 {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
            }

                .dream-ai-suggestions h5 i {
                    color: var(--warning-color);
                }

        /* Stili per i tab suggerimenti */
        .suggestion-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .suggestion-tab {
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-right: 5px;
        }

            .suggestion-tab:hover {
                background-color: rgba(0, 123, 255, 0.05); /* Usa var(--primary-light) se definito e appropriato */
                border-bottom: 2px solid rgba(0, 123, 255, 0.3); /* Usa var(--primary-color) con opacità */
            }

            .suggestion-tab.active {
                font-weight: 500;
                border-bottom: 2px solid var(--primary-color); /* Usa var(--primary-color) */
                color: var(--primary-color); /* Usa var(--primary-color) */
            }

        .suggestion-pane {
            display: none;
            padding: 10px 0;
        }

            .suggestion-pane.active {
                display: block;
            }

        /* Plan details */
        .plan-date-range {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 5px 15px;
            display: inline-flex; /* Per non occupare tutta la larghezza */
        }

        .plan-details-section {
            margin-bottom: 30px;
        }

            .plan-details-section h5 {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 15px;
                color: var(--dark-color); /* CORRETTO: --dark-color */
            }

                .plan-details-section h5 i {
                    color: var(--primary-color); /* CORRETTO: --primary-color */
                }

        .plan-progress-bar {
            margin-bottom: 20px;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plan-detailed-checklist {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .plan-detailed-checklist li {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 15px;
                background-color: var(--light-color); /* CORRETTO: --light-color */
                border-radius: 8px;
                margin-bottom: 10px;
                transition: var(--transition); /* CORRETTO: --transition */
            }

                .plan-detailed-checklist li:hover {
                    background-color: var(--primary-light); /* CORRETTO: --primary-light */
                }

                .plan-detailed-checklist li.completed {
                    background-color: var(--accent-light); /* CORRETTO: --accent-light */
                    text-decoration: line-through;
                    color: var(--muted-color); /* CORRETTO: --muted-color */
                }

                .plan-detailed-checklist li i { /* Icona check/circle */
                    color: var(--accent-color); /* O var(--primary-color) se più coerente */
                }

            .plan-detailed-checklist .checklist-text {
                flex: 1;
            }

            .plan-detailed-checklist .checklist-category {
                background-color: rgba(0,0,0,0.05);
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.8rem;
                color: var(--muted-color); /* CORRETTO: --muted-color */
            }

            .plan-detailed-checklist .checklist-due {
                font-size: 0.8rem;
                color: var(--warning-color);
            }

        /* Info cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--box-shadow); /* CORRETTO: --box-shadow */
        }

        .info-card-title {
            background-color: var(--primary-light); /* CORRETTO: --primary-light */
            color: var(--primary-color); /* CORRETTO: --primary-color */
            padding: 10px 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card-content {
            padding: 15px;
            font-size: 0.9rem;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .weather-icon {
            font-size: 2rem;
            color: var(--warning-color);
        }

        .weather-temp {
            font-weight: 700;
        }

        .weather-desc {
            color: var(--muted-color); /* CORRETTO: --muted-color */
        }

        .weather-forecast {
            margin-top: 10px;
            font-style: italic;
            font-size: 0.8rem;
            color: var(--muted-color); /* CORRETTO: --muted-color */
        }

        .explore-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

            .explore-buttons .btn {
                flex: 1;
            }

        /* Leaflet custom styles */
        .custom-marker-icon i { /* Icona dentro al marker sulla mappa */
            color: var(--primary-color); /* O un altro colore se i marker devono differenziarsi dal colore primario UI */
        }

        .custom-popup {
            font-family: 'Roboto', sans-serif; /* O la font family del sito */
        }

            .custom-popup h3 {
                margin: 0 0 5px 0;
                font-size: 1.2rem;
            }

            .custom-popup p {
                margin: 0 0 10px 0;
                color: var(--muted-color); /* CORRETTO: --muted-color */
            }

        /* Responsive */
        @@media (max-width: 992px) {
            .dreammap-container {
                grid-template-columns: 1fr; /* Stack su mobile */
                grid-template-rows: 1fr 350px; /* Mappa sopra, sidebar sotto con altezza fissa */
            }

            .dreammap-main { /* Mappa */
                order: 1; /* Appare prima */
            }

            .dreammap-sidebar { /* Sidebar */
                order: 2; /* Appare dopo */
                height: 350px; /* Altezza fissa per lo scroll */
                overflow-y: auto; /* Abilita scroll verticale se il contenuto eccede */
            }

            .info-cards {
                grid-template-columns: 1fr; /* Info cards in una colonna su mobile */
            }
        }

        @@media (max-width: 768px) {
            .dream-details-info {
                gap: 15px;
            }

            .detail-item {
                flex: 1 1 100%; /* Elementi dettaglio a tutta larghezza */
            }

            .discover-grid {
                grid-template-columns: 1fr; /* Card Discover in una colonna */
            }
        }
    </style>
}

    @section Scripts {
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let map;
        let markers = [];
        let markerClusters;

        // Dati delle destinazioni
        const destinations = @Html.Raw(Json.Serialize(Model.AllDestinations));

        function initMap() {
            // Inizializza la mappa Leaflet con opzioni di limitazione
            map = L.map('dreamMap', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2, // Limita il livello minimo di zoom
                maxBounds: [[-90, -180], [90, 180]], // Limita i confini della mappa
                maxBoundsViscosity: 1.0, // Mantiene la mappa all'interno dei limiti
                worldCopyJump: true, // Gestisce meglio la navigazione ai bordi della mappa
                zoomControl: false // <-- MODIFICA QUI: Disabilita il controllo zoom di default
            });

            // Aggiungi i controlli di zoom nella posizione desiderata (questo è il tuo controllo personalizzato)
            L.control.zoom({
                position: 'topleft'
            }).addTo(map);

            // Aggiungi il layer di base della mappa con noWrap per evitare ripetizioni
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                noWrap: true // Importante: impedisce la ripetizione della mappa
            }).addTo(map);

            // Inizializza il cluster per i marker
            markerClusters = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                iconCreateFunction: function (cluster) {
                    return L.divIcon({
                        html: '<div class="cluster-icon">' + cluster.getChildCount() + '</div>',
                        className: 'custom-cluster-icon',
                        iconSize: L.point(40, 40)
                    });
                }
            });
            map.addLayer(markerClusters);

            // Aggiungi un handler per gli errori di movimento della mappa
            map.on('error', function (e) {
                console.error('Errore mappa:', e.error);
            });
        }

        function loadMapMarkers() {
            console.log('Aggiornamento marker sulla mappa');

            if (markerClusters) {
                markerClusters.clearLayers();
            }
            markers = [];

            if (!destinations) {
                console.error('Dati delle destinazioni non disponibili');
                destinations = { wishlist: [], plannedTrips: [], visitedCities: [] };
            }

            if (!Array.isArray(destinations.wishlist)) destinations.wishlist = [];
            if (!Array.isArray(destinations.plannedTrips)) destinations.plannedTrips = [];
            if (!Array.isArray(destinations.visitedCities)) destinations.visitedCities = [];

            console.log('Dati wishlist:', destinations.wishlist.length);
            console.log('Dati piani:', destinations.plannedTrips.length);
            console.log('Dati visite:', destinations.visitedCities.length);

            destinations.wishlist.forEach(function (dream) {
                if (!isValidLatitude(dream.latitude) || !isValidLongitude(dream.longitude)) {
                    console.error(`Coordinate non valide per ${dream.cityName}: lat=${dream.latitude}, lng=${dream.longitude}`);
                    return;
                }
                const marker = createMarker(dream.latitude, dream.longitude, dream.cityName, dream.countryName, 'dream', dream.priority, dream.id);
                markers.push(marker);
                markerClusters.addLayer(marker);
            });

            destinations.plannedTrips.forEach(function (plan) {
                if (!isValidLatitude(plan.latitude) || !isValidLongitude(plan.longitude)) {
                    console.error(`Coordinate non valide per ${plan.cityName}: lat=${plan.latitude}, lng=${plan.longitude}`);
                    return;
                }
                const marker = createMarker(plan.latitude, plan.longitude, plan.cityName, plan.countryName, 'plan', plan.completionPercentage || 0, plan.id);
                markers.push(marker);
                markerClusters.addLayer(marker);
            });

            destinations.visitedCities.forEach(function (visit) {
                if (!isValidLatitude(visit.latitude) || !isValidLongitude(visit.longitude)) {
                    console.error(`Coordinate non valide per ${visit.cityName}: lat=${visit.latitude}, lng=${visit.longitude}`);
                    return;
                }
                const marker = createMarker(visit.latitude, visit.longitude, visit.cityName, visit.countryName, 'visited', null, visit.id);
                markers.push(marker);
                markerClusters.addLayer(marker);
            });
        }

        function createMarker(lat, lng, city, country, type, detail, id) {
            let color, icon;
            switch (type) {
                case 'dream': color = '#ff9800'; icon = 'star'; break;
                case 'plan': color = '#4a90e2'; icon = 'plane-departure'; break;
                case 'visited': color = '#4caf50'; icon = 'check-circle'; break;
                default: color = '#607d8b'; icon = 'map-marker-alt';
            }

            const customIcon = L.divIcon({
                html: `<div style="background-color: ${color}"><i class="fas fa-${icon}"></i></div>`,
                className: 'custom-marker-icon',
                iconSize: [30, 30]
            });

            const marker = L.marker([lat, lng], { icon: customIcon });
            marker.itemId = id;
            marker.itemType = type;

            let popupContent = `<div class="custom-popup"><h3>${city}</h3><p>${country}</p>`;
            if (type === 'dream') {
                const stars = '⭐'.repeat(detail || 1);
                popupContent += `<p>Priorità: ${stars}</p><button class="btn btn-sm btn-primary" onclick="showDreamDetails('${id}')">Dettagli</button>`;
            } else if (type === 'plan') {
                popupContent += `<p>Completamento: ${detail || 0}%</p><div class="progress mb-2" style="height: 5px"><div class="progress-bar" style="width: ${detail || 0}%"></div></div><button class="btn btn-sm btn-primary" onclick="showPlanDetails('${id}')">Dettagli</button>`;
            } else {
                popupContent += `<p>Già visitata</p><button class="btn btn-sm btn-primary" onclick="showVisitDetails('${id}')">Ricordi</button>`;
            }
            popupContent += `</div>`;
            marker.bindPopup(popupContent);
            return marker;
        }

        function flyToDestination(lat, lng) {
            if (!map) { console.error("Mappa non inizializzata"); return; }
            if (!isValidLatitude(lat) || !isValidLongitude(lng)) { console.error(`Coordinate non valide: lat=${lat}, lng=${lng}`); return; }

            console.log(`Spostamento della mappa a: lat=${lat}, lng=${lng}`);
            lat = parseFloat(lat);
            lng = parseFloat(lng);
            lat = Math.max(-85, Math.min(85, lat));
            lng = ((lng + 540) % 360) - 180;

            map.flyTo([lat, lng], 10, { duration: 1.5, easeLinearity: 0.25, animate: true });

            let foundMarker = markers.find(marker => {
                const markerLat = marker.getLatLng().lat;
                const markerLng = marker.getLatLng().lng;
                return Math.abs(markerLat - lat) < 0.1 && Math.abs(markerLng - lng) < 0.1;
            });

            if (foundMarker) {
                setTimeout(() => { foundMarker.openPopup(); }, 1600);
            }
        }

        function isValidLatitude(lat) { return typeof lat === 'number' && !isNaN(lat) && lat >= -90 && lat <= 90; }
        function isValidLongitude(lng) { return typeof lng === 'number' && !isNaN(lng) && lng >= -180 && lng <= 180; }
        function normalizeLongitude(lng) { lng = ((lng + 180) % 360) - 180; if (lng === -180) lng = 180; return lng; }

        function setupEventListeners() {
            document.querySelectorAll('[role="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (e) {
                    setTimeout(() => { if (map) map.invalidateSize(); }, 100);
                });
            });

            document.addEventListener('click', function (e) {
                const dreamItem = e.target.closest('.dream-item');
                const planItem = e.target.closest('.plan-item');
                if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.tagName === 'A' || e.target.closest('a')) {
                    return;
                }
                if (dreamItem) {
                    const lat = parseFloat(dreamItem.getAttribute('data-lat'));
                    const lng = parseFloat(dreamItem.getAttribute('data-lng'));
                    if (isValidLatitude(lat) && isValidLongitude(lng)) flyToDestination(lat, lng);
                } else if (planItem) {
                    const lat = parseFloat(planItem.getAttribute('data-lat'));
                    const lng = parseFloat(planItem.getAttribute('data-lng'));
                    if (isValidLatitude(lat) && isValidLongitude(lng)) flyToDestination(lat, lng);
                }
            });

            // <-- MODIFICA QUI: Aggiungi listener per il resize della finestra -->
            window.addEventListener('resize', function() {
                if (map) {
                    map.invalidateSize();
                }
            });
        }

        function filterItems(containerId, searchText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const items = container.querySelectorAll('.dream-item, .plan-item');
            items.forEach(item => {
                const cityName = (item.dataset.city || '').toLowerCase();
                const countryName = (item.dataset.country || '').toLowerCase();
                item.style.display = (cityName.includes(searchText) || countryName.includes(searchText)) ? '' : 'none';
            });
        }

        function showLoadingOverlay(message = 'Caricamento...') {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
            overlay.innerHTML = `<div class="bg-white p-4 rounded shadow"><div class="d-flex align-items-center"><div class="spinner-border text-primary me-3" role="status"></div><span>${message}</span></div></div>`;
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) document.body.removeChild(overlay);
        }

        // UNICA DEFINIZIONE CORRETTA
        function formatDateForInput(date) {
            if (!date) return '';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';

            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showDreamDetails(dreamId) {
            try {
                console.log('Mostra dettagli sogno:', dreamId);
                if (!dreamId) { console.error('ID non valido'); showToast('Errore', 'ID destinazione non valido', 'danger'); return; }

                let dreamData = destinations.wishlist.find(d => d.id && d.id.toString() === dreamId.toString());
                let dataSource = dreamData ? 'wishlist' : '';

                if (!dreamData) {
                    const planAttempt = destinations.plannedTrips.find(p => p.id && p.id.toString() === dreamId.toString());
                    if (planAttempt) { showPlanDetails(dreamId); return; }
                }
                if (!dreamData) {
                    const visitedAttempt = destinations.visitedCities.find(v => v.id && v.id.toString() === dreamId.toString());
                    if (visitedAttempt) { showVisitDetails(dreamId); return; }
                }

                if (!dreamData) { // Fallback if not found anywhere
                    const element = document.querySelector(`.dream-item[data-id="${dreamId}"]`);
                    if (element) {
                        dreamData = {
                            id: dreamId,
                            cityName: element.querySelector('.dream-name')?.textContent || 'N/A',
                            countryName: element.querySelector('.dream-country')?.textContent || 'N/A',
                            imageUrl: element.querySelector('img')?.src || '/images/placeholder-city.jpg',
                            notes: '', latitude: parseFloat(element.getAttribute('data-lat')), longitude: parseFloat(element.getAttribute('data-lng')),
                            priority: element.querySelector('.dream-priority')?.classList.contains('high') ? 3 : (element.querySelector('.dream-priority')?.classList.contains('medium') ? 2 : 1),
                            tags: ['viaggio'], addedOn: new Date().toLocaleDateString()
                        };
                        dataSource = 'dom-fallback';
                    } else {
                        dreamData = { id: dreamId, cityName: 'Sconosciuto', countryName: 'Sconosciuto', imageUrl: '/images/placeholder-city.jpg', notes: '', latitude: 0, longitude: 0, priority: 1, tags: [], addedOn: new Date().toLocaleDateString() };
                        dataSource = 'super-fallback';
                    }
                }
                console.log(`Dati sogno trovati in ${dataSource}:`, dreamData);

                const modal = document.getElementById('dreamDetailsModal');
                modal.setAttribute('data-dream-id', dreamId);

                document.getElementById('detailsCityName').textContent = dreamData.cityName;
                document.getElementById('detailsCountryName').textContent = dreamData.countryName;
                const bannerImg = document.getElementById('detailsBannerImg');
                bannerImg.onerror = function () { this.src = '/images/placeholder-city.jpg'; };
                bannerImg.src = dreamData.imageUrl;
                document.getElementById('detailsDate').textContent = dreamData.addedOn ? (typeof dreamData.addedOn === 'string' ? dreamData.addedOn : new Date(dreamData.addedOn).toLocaleDateString()) : 'N/A';
                const noteElement = document.getElementById('detailsNote');
                noteElement.textContent = dreamData.notes || 'Nessuna nota.';
                noteElement.style.fontStyle = dreamData.notes ? 'normal' : 'italic';

                const priorityDiv = document.getElementById('detailsPriority');
                priorityDiv.innerHTML = Array(dreamData.priority || 1).fill(0).map(() => '<i class="fas fa-star" style="color: #FFD700;"></i>').join('');

                const tagsDiv = document.getElementById('detailsTags');
                tagsDiv.innerHTML = (dreamData.tags || ['viaggio']).map(tag => `<span class="dream-tag" style="background-color: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 15px; margin: 0 4px 4px 0; display: inline-block; font-size: 0.9rem;">${tag}</span>`).join('');

                setupExternalLinks(dreamData.cityName, dreamData.countryName);
                ['attractions', 'gastronomy', 'history', 'tips'].forEach(type => loadAISuggestions(type, dreamData.cityName));
                setTimeout(initializeSuggestionTabs, 100);

                const planTripBtn = document.getElementById('planTripBtn');
                planTripBtn.style.display = (dataSource === 'wishlist' || dataSource === 'dom-fallback') ? 'block' : 'none'; // Allow planning if from DOM fallback as well
                if (planTripBtn.style.display === 'block') {
                    planTripBtn.onclick = () => moveToPlanningPhase(dreamId);
                }

                if (isValidLatitude(dreamData.latitude) && isValidLongitude(dreamData.longitude)) flyToDestination(dreamData.latitude, dreamData.longitude);

                new bootstrap.Modal(modal).show();
            } catch (error) {
                console.error('Errore in showDreamDetails:', error);
                showToast('Errore', 'Dettagli non caricati.', 'danger');
            }
        }

        function addToWishlist(cityId) {
            showLoadingOverlay('Aggiunta alla wishlist...');
            fetch('/DreamMap?handler=AddToWishlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiForgeryToken() },
                body: JSON.stringify({ cityId: cityId })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    if (data.success) {
                        if (!destinations.wishlist) destinations.wishlist = [];
                        destinations.wishlist.push(data.newItem);
                        sincronizzaStatoApp();
                        showToast('Successo', 'Destinazione aggiunta!', 'success');
                    } else {
                        showToast('Errore', data.message || 'Errore aggiunta.', 'danger');
                    }
                })
                .catch(error => {
                    hideLoadingOverlay();
                    console.error('Error:', error);
                    showToast('Errore', 'Errore connessione.', 'danger');
                });
        }

        function ricostruisciSidebar() {
            const wishlistContainer = document.getElementById('wishlistItems');
            if (wishlistContainer) {
                wishlistContainer.innerHTML = '';
                if (!destinations.wishlist || destinations.wishlist.length === 0) {
                    wishlistContainer.innerHTML = `<div class="empty-state"><img src="/images/empty-wishlist.svg" alt="Wishlist vuota" class="empty-state-icon"><p>La tua lista dei desideri è vuota</p><p class="text-muted">Aggiungi destinazioni qui sotto</p></div>`;
                } else {
                    destinations.wishlist.forEach(dream => {
                        if (!dream || !dream.cityName) { console.error('Invalid dream item:', dream); return; }
                        const priorityClass = dream.priority === 3 ? 'high' : dream.priority === 2 ? 'medium' : 'low';
                        const starsHtml = Array(dream.priority || 1).fill(0).map(() => '<i class="fas fa-star"></i>').join('');
                        const dreamItemHtml = `
                                            <div class="dream-item" data-city="${(dream.cityName || '').toLowerCase()}" data-country="${(dream.countryName || '').toLowerCase()}"
                                                data-id="${dream.id}" data-lat="${dream.latitude}" data-lng="${dream.longitude}"
                                                onclick="flyToDestination(${dream.latitude}, ${dream.longitude})">
                                                <div class="dream-item-image">
                                                    <img src="${dream.imageUrl || '/images/placeholder-city.jpg'}" alt="${dream.cityName}" onerror="this.src='/images/placeholder-city.jpg'">
                                                    <div class="dream-flag"><img src="/images/flags/${getCountryCode(dream.countryName).toLowerCase()}.png" alt="${dream.countryName}"></div>
                                                </div>
                                                <div class="dream-item-content">
                                                    <div class="dream-priority ${priorityClass}">${starsHtml}</div>
                                                    <h3 class="dream-name">${dream.cityName}</h3>
                                                    <p class="dream-country">${dream.countryName || ''}</p>
                                                    <div class="dream-tags">${(dream.tags || ['viaggio']).map(tag => `<span class="dream-tag">${tag}</span>`).join('')}</div>
                                                    <div class="dream-note">${dream.notes ? (dream.notes.length > 100 ? dream.notes.substring(0, 100) + "..." : dream.notes) : ''}</div>
                                                </div>
                                                <div class="dream-item-actions">
                                                    <button type="button" class="btn btn-sm btn-outline-info show-details-btn" data-id="${dream.id}"><i class="fas fa-info-circle"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="moveToPlanningPhase('${dream.id}')"><i class="fas fa-calendar-plus"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDream('${dream.id}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>`;
                        wishlistContainer.innerHTML += dreamItemHtml;
                    });
                }
            }
            // Ricostruzione della sezione "In Pianificazione" (simile alla wishlist)
            const planningContainer = document.getElementById('planningItems');
            if (planningContainer) {
                planningContainer.innerHTML = '';
                if (!destinations.plannedTrips || destinations.plannedTrips.length === 0) {
                    planningContainer.innerHTML = `<div class="empty-state"><img src="/images/empty-planning.svg" alt="Nessun viaggio" class="empty-state-icon"><p>Non hai viaggi pianificati</p><p class="text-muted">Sposta un sogno qui per iniziare.</p></div>`;
                } else {
                    destinations.plannedTrips.forEach(plan => {
                        if (!plan || !plan.cityName) { console.error('Invalid plan item:', plan); return; }
                        const countdownDays = plan.startDate ? Math.max(0, Math.ceil((new Date(plan.startDate) - new Date()) / (1000 * 60 * 60 * 24))) : 0;
                        const checklistPreview = plan.checklist && plan.checklist.length > 0 ?
                            plan.checklist.slice(0, 3).map(item => `<li class="${item.isCompleted ? "completed" : ""}"><i class="${item.isCompleted ? "fas fa-check-circle" : "far fa-circle"}"></i> ${item.title}</li>`).join('') +
                            (plan.checklist.length > 3 ? `<li class="more">+ altri ${plan.checklist.length - 3} elementi</li>` : '')
                            : '<li>Nessuna checklist.</li>';

                        const planItemHtml = `
                                            <div class="plan-item" data-city="${(plan.cityName || '').toLowerCase()}" data-country="${(plan.countryName || '').toLowerCase()}"
                                                data-id="${plan.id}" data-lat="${plan.latitude}" data-lng="${plan.longitude}"
                                                onclick="flyToDestination(${plan.latitude}, ${plan.longitude})">
                                                <div class="plan-item-image">
                                                    <img src="${plan.imageUrl || '/images/placeholder-city.jpg'}" alt="${plan.cityName}" onerror="this.src='/images/placeholder-city.jpg'">
                                                    <div class="plan-flag"><img src="/images/flags/${getCountryCode(plan.countryName).toLowerCase()}.png" alt="${plan.countryName}"></div>
                                                    <div class="plan-dates"><div class="plan-date-icon"><i class="fas fa-plane-departure"></i></div><div class="plan-date-range">${plan.startDate ? new Date(plan.startDate).toLocaleDateString("it-IT") : 'N/A'}</div></div>
                                                </div>
                                                <div class="plan-item-content">
                                                    <h3 class="plan-name">${plan.cityName}</h3>
                                                    <p class="plan-country">${plan.countryName || ''}</p>
                                                    <div class="plan-countdown"><i class="far fa-calendar-alt"></i><strong>${countdownDays}</strong> giorni rimanenti</div>
                                                    <div class="plan-progress">
                                                        <div class="progress"><div class="progress-bar" role="progressbar" style="width: ${plan.completionPercentage || 0}%" aria-valuenow="${plan.completionPercentage || 0}" aria-valuemin="0" aria-valuemax="100"></div></div>
                                                        <span class="plan-progress-text">${plan.completionPercentage || 0}% completato</span>
                                                    </div>
                                                    <ul class="plan-checklist">${checklistPreview}</ul>
                                                </div>
                                                <div class="plan-item-actions">
                                                    <button type="button" class="btn btn-sm btn-outline-info show-details-btn" data-id="${plan.id}"><i class="fas fa-info-circle"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="markAsVisited('${plan.id}')"><i class="fas fa-check"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePlan('${plan.id}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>`;
                        planningContainer.innerHTML += planItemHtml;
                    });
                }
            }
            initializeDetailButtons(); // Cruciale riattaccare listener ai nuovi bottoni
        }

        function initializeDetailButtons() {
            console.log("Inizializzazione pulsanti dettagli");
            document.querySelectorAll('.show-details-btn').forEach(button => {
                // Rimuove listener esistenti clonando il bottone
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function (event) {
                    event.stopPropagation();
                    const itemId = this.getAttribute('data-id');
                    const itemElement = this.closest('.dream-item, .plan-item');
                    if (itemElement && itemId) {
                        if (itemElement.classList.contains('dream-item')) {
                            showDreamDetails(itemId);
                        } else if (itemElement.classList.contains('plan-item')) {
                            showPlanDetails(itemId);
                        }
                    } else {
                        console.error("ID o elemento non trovato per il pulsante dettagli.");
                    }
                });
            });
        }

        function loadAISuggestions(type, cityName) {
            console.log(`Caricamento suggerimenti ${type} per ${cityName}`);
            const suggestionPane = document.getElementById(`suggestions${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (!suggestionPane) { console.error('Pane non trovato:', `suggestions${type.charAt(0).toUpperCase() + type.slice(1)}`); return; }

            suggestionPane.innerHTML = `<div class="ai-loading"><div class="spinner-border text-primary"></div><p>Generando suggerimenti...</p></div>`;
            fetch(`/DreamMap?handler=Travelsuggestions&cityName=${encodeURIComponent(cityName)}&suggestionType=${encodeURIComponent(type)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.html) {
                        let cleanedHtml = data.html.replace(/^\s*```(?:html|HTML)?\s*\n?/i, '').replace(/\s*```\s*$/, '').replace(/^\s*<pre>\s*|\s*<\/pre>\s*$/g, '');
                        suggestionPane.innerHTML = cleanedHtml.trim() ? cleanedHtml : '<div class="ai-error"><p>Nessun suggerimento disponibile.</p></div>';
                        if (type === 'attractions') document.querySelector('.suggestion-tab[data-tab="attractions"]')?.click();
                    } else {
                        suggestionPane.innerHTML = `<div class="ai-error"><p>Errore suggerimenti: ${data.error || 'Sconosciuto'}</p></div>`;
                    }
                })
                .catch(error => {
                    console.error("Errore API suggerimenti:", error);
                    suggestionPane.innerHTML = `<div class="ai-error"><p>Errore caricamento suggerimenti per ${cityName}.</p><button class="btn btn-sm btn-outline-primary mt-3" onclick="loadAISuggestions('${type}', '${cityName}')">Riprova</button></div>`;
                });
        }


        function showPlanDetails(planId) {
            console.log('[showPlanDetails] Tentativo di mostrare dettagli per PlanId:', planId, '(Tipo:', typeof planId, ')');
            try {
                if (!planId || String(planId).trim() === '') {
                    console.error('[showPlanDetails] ERRORE: ID piano nullo, vuoto o non valido fornito.');
                    showToast('Errore', 'ID piano non valido o mancante per visualizzare i dettagli.', 'danger');
                    return;
                }

                const planIdStr = String(planId).trim(); // Normalizza a stringa
                console.log('[showPlanDetails] PlanId normalizzato a stringa:', planIdStr);

                let planData = destinations.plannedTrips.find(p => p && p.id && String(p.id).trim() === planIdStr);
                console.log('[showPlanDetails] Piano trovato nei dati locali (destinations.plannedTrips):', planData ? 'Sì' : 'No', planData);

                if (!planData) {
                    const element = document.querySelector(`.plan-item[data-id="${planIdStr}"]`);
                    if (element) {
                        console.warn('[showPlanDetails] Piano non trovato in destinations.plannedTrips. Tento fallback al DOM.');
                        planData = {
                            id: planIdStr,
                            cityName: element.querySelector('.plan-name')?.textContent || 'N/A (da DOM)',
                            countryName: element.querySelector('.plan-country')?.textContent || 'N/A (da DOM)',
                            imageUrl: element.querySelector('.plan-item-image img')?.src || '/images/placeholder-city.jpg',
                            startDate: new Date(), // Valore di fallback
                            endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Fallback
                            completionPercentage: parseInt(element.querySelector('.plan-progress-text')?.textContent) || 0,
                            notes: 'Note non caricate (fallback DOM)',
                            latitude: parseFloat(element.getAttribute('data-lat')) || 0,
                            longitude: parseFloat(element.getAttribute('data-lng')) || 0,
                            checklist: [] // Fallback checklist vuota
                        };
                        // Aggiungi questo fallback ai dati locali per coerenza temporanea
                        if (!destinations.plannedTrips.find(p => p && p.id && String(p.id).trim() === planIdStr)) {
                            destinations.plannedTrips.push(planData);
                            console.log('[showPlanDetails] Dati di fallback aggiunti a destinations.plannedTrips.');
                        }
                    } else {
                        console.error(`[showPlanDetails] ERRORE CRITICO: Impossibile trovare dati per PlanId '${planIdStr}' né in destinations.plannedTrips né nel DOM.`);
                        showToast('Errore Dati', `Dati piano per ID '${planIdStr}' non trovati.`, 'danger');
                        return;
                    }
                }

                planData.checklist = planData.checklist || []; // Assicura che checklist sia un array
                console.log('[showPlanDetails] Dati piano finali da usare:', JSON.parse(JSON.stringify(planData))); // Log profondo dei dati

                const modal = document.getElementById('planDetailsModal');
                if (!modal) {
                    console.error("[showPlanDetails] ERRORE CRITICO: Elemento modal 'planDetailsModal' non trovato nel DOM.");
                    return;
                }
                modal.setAttribute('data-plan-id', planData.id); // Usa l'ID dai dati (che è stato normalizzato)
                console.log('[showPlanDetails] Attributo data-plan-id del modal impostato a:', modal.getAttribute('data-plan-id'));

                // Popolamento del modal (assicurati che gli ID degli elementi siano corretti)
                document.getElementById('planCityName').textContent = planData.cityName;
                document.getElementById('planCountryName').textContent = planData.countryName;

                const bannerImg = document.getElementById('planBannerImg');
                if (bannerImg) {
                    bannerImg.onerror = function () { this.src = '/images/placeholder-city.jpg'; };
                    bannerImg.src = planData.imageUrl || '/images/placeholder-city.jpg';
                }

                const startDate = planData.startDate ? new Date(planData.startDate) : new Date();
                const endDate = planData.endDate ? new Date(planData.endDate) : new Date(new Date(startDate).setDate(startDate.getDate() + 7));

                const planDateRangeDisplaySpan = document.getElementById('planDateRange')?.querySelector('span');
                if (planDateRangeDisplaySpan) {
                    planDateRangeDisplaySpan.textContent = `${startDate.toLocaleDateString("it-IT")} - ${endDate.toLocaleDateString("it-IT")}`;
                }

                document.getElementById('planStartDateInput').value = formatDateForInput(startDate);
                document.getElementById('planEndDateInput').value = formatDateForInput(endDate);
                document.getElementById('planNotes').value = planData.notes || '';

                renderChecklistInModal(planData.id); // Usa l'ID normalizzato
                updateCompletionPercentage(planData.id); // Usa l'ID normalizzato

                // Configura pulsante aggiungi item checklist
                const addChecklistItemBtnInModal = document.getElementById('addChecklistItem');
                if (addChecklistItemBtnInModal) {
                    const newAddBtn = addChecklistItemBtnInModal.cloneNode(true);
                    addChecklistItemBtnInModal.parentNode.replaceChild(newAddBtn, addChecklistItemBtnInModal);
                    newAddBtn.onclick = () => {
                        const addModalEl = document.getElementById('addChecklistItemModal');
                        if (addModalEl) {
                            addModalEl.setAttribute('data-current-plan-id', planData.id); // Imposta l'ID del piano corrente
                            document.getElementById('checklistItemTitle').value = '';
                            document.getElementById('checklistItemCategory').value = 'travel';
                            document.getElementById('checklistItemDueDate').value = '';
                            new bootstrap.Modal(addModalEl).show();
                        } else {
                            console.error("[showPlanDetails] Modal 'addChecklistItemModal' non trovato.");
                        }
                    };
                }

                populateCountryInfo(planData.countryName); // Assicurati che questa funzione esista e funzioni
                setupExternalLinks(planData.cityName, planData.countryName); // Assicurati che questa esista

                configuraPulsantiModal(); // Chiamata FONDAMENTALE dopo aver popolato e PRIMA di mostrare il modal

                if (isValidLatitude(planData.latitude) && isValidLongitude(planData.longitude)) {
                    flyToDestination(planData.latitude, planData.longitude);
                }

                console.log('[showPlanDetails] Apertura modal planDetailsModal...');
                new bootstrap.Modal(modal).show();
                console.log('[showPlanDetails] Modal planDetailsModal dovrebbe essere visibile.');

            } catch (error) {
                console.error('[showPlanDetails] Eccezione CRITICA:', error);
                showToast('Errore JavaScript', `Errore imprevisto in showPlanDetails: ${error.message}`, 'danger');
            }
        }



        function renderChecklistInModal(planId) {
            const planIndex = destinations.plannedTrips.findIndex(p => p.id && p.id.toString() === planId);
            if (planIndex === -1) { console.error("Piano non trovato per renderChecklistInModal:", planId); return; }
            const planData = destinations.plannedTrips[planIndex];
            planData.checklist = planData.checklist || []; // Assicura che sia un array

            const checklistContainer = document.getElementById('planChecklist');
            checklistContainer.innerHTML = '';
            if (planData.checklist.length > 0) {
                planData.checklist.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = item.isCompleted ? 'completed' : '';
                    listItem.dataset.id = item.id;

                    const checkIcon = document.createElement('i');
                    checkIcon.className = item.isCompleted ? 'fas fa-check-circle' : 'far fa-circle';
                    checkIcon.style.cursor = 'pointer';
                    checkIcon.onclick = () => toggleChecklistItem(planId, item.id);

                    const textDiv = document.createElement('div');
                    textDiv.className = 'checklist-text';
                    textDiv.textContent = item.title;

                    const categorySpan = document.createElement('span');
                    categorySpan.className = 'checklist-category';
                    categorySpan.textContent = getCategoryLabel(item.category);

                    const dueSpan = document.createElement('span');
                    dueSpan.className = 'checklist-due';
                    if (item.dueDate) {
                        dueSpan.innerHTML = `<i class="far fa-calendar-alt"></i> ${new Date(item.dueDate).toLocaleDateString()}`;
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-outline-danger ms-auto remove-checklist-item-btn';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.type = 'button';
                    removeBtn.onclick = () => removeChecklistItem(planId, item.id);

                    listItem.appendChild(checkIcon);
                    listItem.appendChild(textDiv);
                    listItem.appendChild(categorySpan);
                    listItem.appendChild(dueSpan);
                    listItem.appendChild(removeBtn);
                    checklistContainer.appendChild(listItem);
                });
            } else {
                checklistContainer.innerHTML = '<li class="text-muted fst-italic">Nessun elemento nella checklist.</li>';
            }
        }

        // UNICA DEFINIZIONE CORRETTA
        function getCategoryLabel(category) {
            const labels = { 'travel': 'Viaggio', 'accommodation': 'Alloggio', 'documents': 'Documenti', 'activities': 'Attività', 'other': 'Altro' };
            return labels[category] || category;
        }

        function sincronizzaStatoApp() {
            console.log('Sincronizzazione stato app...');
            if (!destinations) destinations = { wishlist: [], plannedTrips: [], visitedCities: [] };
            if (!destinations.wishlist) destinations.wishlist = [];
            if (!destinations.plannedTrips) destinations.plannedTrips = [];
            if (!destinations.visitedCities) destinations.visitedCities = [];

            ricostruisciSidebar();
            if (map) {
                setTimeout(() => { loadMapMarkers(); map.invalidateSize(); }, 200);
            }
        }

        function configuraPulsantiModal() {
            console.log("[configuraPulsantiModal] Inizio configurazione pulsanti modal dei dettagli del piano.");
            const planDetailsModalEl = document.getElementById('planDetailsModal');
            const updatePlanBtn = document.getElementById('updatePlanBtn');
            const removePlanBtn = document.getElementById('removePlanBtn');
            const markVisitedBtn = document.getElementById('markVisitedBtn');
            const saveNotesBtn = document.getElementById('saveNotesBtn'); // Anche se chiama updatePlanDetails

            if (!planDetailsModalEl) {
                console.error("[configuraPulsantiModal] ERRORE CRITICO: Elemento modal 'planDetailsModal' non trovato nel DOM.");
                return;
            }

            // Configura pulsante "Salva Modifiche" (updatePlanBtn)
            if (updatePlanBtn) {
                const newUpdateBtn = updatePlanBtn.cloneNode(true); // Clona per rimuovere vecchi listener
                updatePlanBtn.parentNode.replaceChild(newUpdateBtn, updatePlanBtn);
                newUpdateBtn.onclick = function () {
                    const planId = planDetailsModalEl.getAttribute('data-plan-id');
                    console.log("[configuraPulsantiModal] Pulsante 'Salva Modifiche' (updatePlanBtn) cliccato. PlanId recuperato dal modal:", planId);
                    if (planId && String(planId).trim() !== '') {
                        updatePlanDetails(planId); // Chiama la funzione principale di aggiornamento
                    } else {
                        console.error("[configuraPulsantiModal] ERRORE: planId non valido o mancante su 'updatePlanBtn'. Impossibile aggiornare.");
                        showToast('Errore Interno', 'ID Piano non valido nel modal. Riprova.', 'danger');
                    }
                };
                console.log("[configuraPulsantiModal] Listener 'onclick' per 'updatePlanBtn' impostato.");
            } else {
                console.warn("[configuraPulsantiModal] AVVISO: Pulsante 'updatePlanBtn' non trovato nel DOM.");
            }

            // Configura pulsante "Salva Note" (saveNotesBtn) - di solito chiama la stessa logica di updatePlanDetails
            if (saveNotesBtn) {
                const newSaveNotesBtn = saveNotesBtn.cloneNode(true);
                saveNotesBtn.parentNode.replaceChild(newSaveNotesBtn, saveNotesBtn);
                newSaveNotesBtn.onclick = function () {
                    const planId = planDetailsModalEl.getAttribute('data-plan-id');
                    console.log("[configuraPulsantiModal] Pulsante 'Salva Note' (saveNotesBtn) cliccato. PlanId recuperato:", planId);
                    if (planId && String(planId).trim() !== '') {
                        updatePlanDetails(planId); // Chiama la stessa funzione di aggiornamento
                    } else {
                        console.error("[configuraPulsantiModal] ERRORE: planId non valido o mancante su 'saveNotesBtn'. Impossibile salvare note.");
                        showToast('Errore Interno', 'ID Piano non valido nel modal per salvare le note. Riprova.', 'danger');
                    }
                };
                console.log("[configuraPulsantiModal] Listener 'onclick' per 'saveNotesBtn' impostato.");
            } else {
                console.warn("[configuraPulsantiModal] AVVISO: Pulsante 'saveNotesBtn' non trovato nel DOM.");
            }

            // Configura pulsante "Elimina Piano" (removePlanBtn)
            if (removePlanBtn) {
                const newRemoveBtn = removePlanBtn.cloneNode(true);
                removePlanBtn.parentNode.replaceChild(newRemoveBtn, removePlanBtn);
                newRemoveBtn.onclick = function () {
                    const planId = planDetailsModalEl.getAttribute('data-plan-id');
                    console.log("[configuraPulsantiModal] Pulsante 'Elimina Piano' (removePlanBtn) cliccato. PlanId recuperato:", planId);
                    if (planId && String(planId).trim() !== '') {
                        removePlan(planId); // Chiama la funzione di rimozione
                    } else {
                        console.error("[configuraPulsantiModal] ERRORE: planId non valido o mancante su 'removePlanBtn'. Impossibile eliminare.");
                        showToast('Errore Interno', 'ID Piano non valido nel modal per eliminare. Riprova.', 'danger');
                    }
                };
                console.log("[configuraPulsantiModal] Listener 'onclick' per 'removePlanBtn' impostato.");
            } else {
                console.warn("[configuraPulsantiModal] AVVISO: Pulsante 'removePlanBtn' non trovato nel DOM.");
            }

            // Configura pulsante "Segna come Visitato" (markVisitedBtn)
            if (markVisitedBtn) {
                const newMarkVisitedBtn = markVisitedBtn.cloneNode(true);
                markVisitedBtn.parentNode.replaceChild(newMarkVisitedBtn, markVisitedBtn);
                newMarkVisitedBtn.onclick = function () {
                    const planId = planDetailsModalEl.getAttribute('data-plan-id');
                    console.log("[configuraPulsantiModal] Pulsante 'Segna come Visitato' (markVisitedBtn) cliccato. PlanId recuperato:", planId);
                    if (planId && String(planId).trim() !== '') {
                        markAsVisited(planId); // Chiama la funzione per marcare come visitato
                    } else {
                        console.error("[configuraPulsantiModal] ERRORE: planId non valido o mancante su 'markVisitedBtn'.");
                        showToast('Errore Interno', 'ID Piano non valido nel modal. Riprova.', 'danger');
                    }
                };
                console.log("[configuraPulsantiModal] Listener 'onclick' per 'markVisitedBtn' impostato.");
            } else {
                console.warn("[configuraPulsantiModal] AVVISO: Pulsante 'markVisitedBtn' non trovato nel DOM.");
            }
            console.log("[configuraPulsantiModal] Fine configurazione pulsanti modal.");
        }


        function getCountryCode(countryName) {
            const countryMap = { 'Italia': 'it', 'Francia': 'fr', 'Germania': 'de', 'Spagna': 'es', 'Regno Unito': 'gb', 'Stati Uniti': 'us', 'Giappone': 'jp' };
            return countryMap[countryName] || 'unknown';
        }

        function setupExternalLinks(cityName, countryName) {
            if (!cityName || !countryName) {
                console.error('Nome città o paese mancante per link esterni');
                return;
            }

            const encodedQuery = encodeURIComponent(`${cityName}, ${countryName}`);

            const setupLink = (id, urlPattern) => {
                const btn = document.getElementById(id);
                if (btn) {
                    const finalUrl = urlPattern.replace('{QUERY}', encodedQuery);
                    btn.href = finalUrl; // Imposta href per accessibilità e fallback

                    // Use a regular function (not arrow function) for proper 'return' statement
                    btn.onclick = function (e) {
                        e.preventDefault();
                        window.open(finalUrl, '_blank');
                        return false;
                    };
                }
            };

            setupLink('googleMapsBtn', 'https://www.google.com/maps/search/{QUERY}');
            setupLink('bookingBtn', 'https://www.booking.com/searchresults.html?ss={QUERY}');
            setupLink('tripAdvisorBtn', 'https://www.tripadvisor.com/Search?q={QUERY}');
        }
        function showVisitDetails(visitId) {
            console.log('[showVisitDetails] Tentativo di mostrare dettagli per VisitId:', visitId);
            const visitData = destinations.visitedCities.find(v => v.id && v.id.toString() === visitId.toString());

            if (!visitData) {
                console.error('[showVisitDetails] Dati visita non trovati per ID:', visitId);
                showToast('Errore', 'Dettagli della visita non trovati.', 'danger');
                return;
            }
            console.log('[showVisitDetails] Dati visita trovati:', visitData);

            const modalElement = document.getElementById('visitDetailsModal');
            if (!modalElement) {
                console.error("[showVisitDetails] ERRORE CRITICO: Elemento modal 'visitDetailsModal' non trovato.");
                return;
            }
            modalElement.setAttribute('data-visit-id', visitId);

            // Popola il banner
            document.getElementById('visitCityName').textContent = visitData.cityName || 'N/D';
            document.getElementById('visitCountryName').textContent = visitData.countryName || 'N/D';
            const bannerImg = document.getElementById('visitBannerImg');
            bannerImg.onerror = function () { this.src = '/images/placeholder-destination.jpg'; };
            bannerImg.src = visitData.imageUrl || '/images/placeholder-destination.jpg';

            // Popola i campi del form
            document.getElementById('visitDateInput').value = visitData.visitDate ? formatDateForInput(visitData.visitDate) : '';
            document.getElementById('visitMemoriesTextarea').value = visitData.memories || '';

            // Popola highlights e companions (se presenti nel tuo modello dati visitData)
            document.getElementById('visitHighlightsInput').value = (visitData.highlights || []).join(', ');
            document.getElementById('visitCompanionsInput').value = (visitData.travelCompanions || []).join(', ');

            // Gestione Rating
            const ratingInput = document.getElementById('visitRatingInput');
            const starsContainer = document.getElementById('visitRatingStars');
            ratingInput.value = visitData.rating || 0;

            starsContainer.querySelectorAll('i').forEach(star => {
                star.classList.remove('fas', 'far'); // Rimuovi entrambe le classi
                star.classList.add(parseInt(star.dataset.value) <= ratingInput.value ? 'fas' : 'far'); // fas per piena, far per vuota

                // Rimuovi vecchi listener per evitare duplicazioni
                const newStar = star.cloneNode(true);
                star.parentNode.replaceChild(newStar, star);

                newStar.addEventListener('click', function () {
                    const newRating = parseInt(this.dataset.value);
                    ratingInput.value = newRating;
                    starsContainer.querySelectorAll('i').forEach(s => {
                        s.classList.remove('fas', 'far');
                        s.classList.add(parseInt(s.dataset.value) <= newRating ? 'fas' : 'far');
                    });
                });
            });

            // Popola Galleria Foto (se presente in visitData.photoUrls)
            const photoGallery = document.getElementById('visitPhotoGallery');
            photoGallery.innerHTML = ''; // Pulisci la galleria
            if (visitData.photoUrls && visitData.photoUrls.length > 0) {
                visitData.photoUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = "Foto del viaggio";
                    img.onerror = function () { this.style.display = 'none'; /* Nascondi se l'immagine non carica */ };
                    photoGallery.appendChild(img);
                });
            } else {
                photoGallery.innerHTML = '<p class="text-muted">Nessuna foto aggiunta per questa visita.</p>';
            }

            // Configura pulsante Salva
            const saveBtn = document.getElementById('saveVisitDetailsBtn');
            const newSaveBtn = saveBtn.cloneNode(true); // Per rimuovere vecchi listener
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.onclick = function () {
                updateVisitDetails(visitId);
            };

            const visitModal = new bootstrap.Modal(modalElement);
            visitModal.show();

            if (isValidLatitude(visitData.latitude) && isValidLongitude(visitData.longitude)) {
                flyToDestination(visitData.latitude, visitData.longitude);
            }
        }

        function updateVisitDetails(visitId) {
            const visitDataIndex = destinations.visitedCities.findIndex(v => v.id && v.id.toString() === visitId.toString());
            if (visitDataIndex === -1) {
                showToast('Errore', 'Impossibile salvare, dati visita non trovati.', 'danger');
                return;
            }

            // Raccogli i dati dal modal
            const visitDate = document.getElementById('visitDateInput').value;
            const rating = parseInt(document.getElementById('visitRatingInput').value) || 0;
            const memories = document.getElementById('visitMemoriesTextarea').value;
            const highlights = document.getElementById('visitHighlightsInput').value.split(',').map(s => s.trim()).filter(s => s);
            const companions = document.getElementById('visitCompanionsInput').value.split(',').map(s => s.trim()).filter(s => s);
            // Per ora, non gestiamo l'upload di nuove foto, solo la persistenza degli URL esistenti (se il backend lo supportasse)

            // Aggiorna l'oggetto nell'array JavaScript 'destinations.visitedCities'
            // Questi campi devono esistere sull'oggetto `MapDestinationItem` nel C# e `visitData` in JS
            destinations.visitedCities[visitDataIndex].visitDate = visitDate ? new Date(visitDate) : null;
            destinations.visitedCities[visitDataIndex].rating = rating;
            destinations.visitedCities[visitDataIndex].memories = memories;
            destinations.visitedCities[visitDataIndex].highlights = highlights; // Assicurati che 'highlights' esista in MapDestinationItem
            destinations.visitedCities[visitDataIndex].travelCompanions = companions; // Assicurati che 'travelCompanions' esista in MapDestinationItem
            // destinations.visitedCities[visitDataIndex].photoUrls = ... (se gestisci gli URL delle foto)


            console.log('Dati visita aggiornati (client-side):', destinations.visitedCities[visitDataIndex]);

            // -------- INIZIO SEZIONE PER CHIAMATA BACKEND (da implementare) --------
            // Qui andrebbe la chiamata fetch al backend per persistere le modifiche.
            // Esempio di struttura della chiamata:
            /*
            showLoadingOverlay('Salvataggio ricordi...');
            fetch('/DreamMap?handler=UpdateVisitedDetails', { // Handler da creare
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                },
                body: JSON.stringify({
                    visitId: visitId,
                    visitDate: visitDate,
                    rating: rating,
                    memories: memories,
                    highlights: highlights,
                    travelCompanions: companions
                    // photoUrls: destinations.visitedCities[visitDataIndex].photoUrls // Invia gli URL esistenti
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingOverlay();
                if (data.success) {
                    // Opzionale: aggiorna l'oggetto locale con i dati restituiti dal server (es. se l'ID o altri campi vengono modificati)
                    // destinations.visitedCities[visitDataIndex] = { ...destinations.visitedCities[visitDataIndex], ...data.updatedVisit };
                    showToast('Successo', 'Ricordi salvati con successo!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('visitDetailsModal')).hide();
                } else {
                    showToast('Errore', data.message || 'Salvataggio dei ricordi fallito.', 'danger');
                }
            })
            .catch(error => {
                hideLoadingOverlay();
                console.error('Errore durante il salvataggio dei ricordi:', error);
                showToast('Errore', 'Errore di connessione durante il salvataggio.', 'danger');
            });
            */
            // -------- FINE SEZIONE PER CHIAMATA BACKEND --------

            // Per ora, simuliamo successo e chiudiamo il modal
            showToast('Info', 'Ricordi aggiornati localmente (salvataggio backend non implementato).', 'info');
            bootstrap.Modal.getInstance(document.getElementById('visitDetailsModal')).hide();

            // Non è necessario chiamare sincronizzaStatoApp() se l'unico impatto visivo
            // è sui dati del modal, a meno che non mostri rating/foto altrove.
            // Se i marker sulla mappa dovessero cambiare (es. colore in base al rating), allora sì.
        }

        function removePlan(planId) {
            if (!confirm('Eliminare questo piano di viaggio?')) return;
            showLoadingOverlay('Eliminazione...');
            fetch('/DreamMap?handler=RemovePlan', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiForgeryToken() }, body: JSON.stringify({ planId })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('planDetailsModal'));
                        if (modal) modal.hide();
                        destinations.plannedTrips = destinations.plannedTrips.filter(plan => plan.id.toString() !== planId.toString());
                        sincronizzaStatoApp();
                        showToast('Successo', 'Piano eliminato!', 'success');
                    } else { showToast('Errore', data.message || 'Errore eliminazione.', 'danger'); }
                })
                .catch(error => { hideLoadingOverlay(); console.error('Errore eliminazione:', error); showToast('Errore', 'Errore connessione.', 'danger'); });
        }

        function markAsVisited(planId) {
            if (!confirm('Segnare come visitato?')) return;
            const plan = destinations.plannedTrips.find(item => item.id && item.id.toString() === planId.toString());
            if (!plan) { showToast('Errore', 'Piano non trovato.', 'danger'); return; }

            showLoadingOverlay('Spostamento...');
            fetch('/DreamMap?handler=MarkAsVisited', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiForgeryToken() }, body: JSON.stringify({ planId })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('planDetailsModal'));
                        if (modal) modal.hide();
                        if (!destinations.visitedCities) destinations.visitedCities = [];
                        const visitData = { ...plan, visitDate: plan.endDate || new Date(), rating: 0, memories: plan.notes || '', photos: [] };
                        destinations.visitedCities.push(visitData);
                        destinations.plannedTrips = destinations.plannedTrips.filter(item => item.id.toString() !== planId.toString());
                        sincronizzaStatoApp();
                        document.getElementById('discover-tab')?.click(); // Vai alla tab Scopri o una tab Visitate se esiste
                        showToast('Successo', 'Segnato come visitato!', 'success');
                    } else { showToast('Errore', data.message || 'Errore spostamento.', 'danger'); }
                })
                .catch(error => { hideLoadingOverlay(); console.error('Errore spostamento:', error); showToast('Errore', 'Errore connessione.', 'danger'); });
        }


        function updatePlanDetails(planId) { // planId dovrebbe essere già una stringa normalizzata da chi la chiama
            console.log('--- [JS updatePlanDetails] FUNZIONE CHIAMATA ---');
            console.log('[JS updatePlanDetails] ID Piano ricevuto:', planId, '(Tipo:', typeof planId, ')');

            if (!planId || String(planId).trim() === '') {
                console.error("[JS updatePlanDetails] ERRORE: ID piano nullo, vuoto o non valido all'inizio della funzione.");
                showToast('Errore Critico JS', 'ID Piano non valido per l\'aggiornamento.', 'danger');
                return;
            }

            const planIdStr = String(planId).trim();
            console.log('[JS updatePlanDetails] ID Piano normalizzato (o riconfermato) a stringa:', planIdStr);

            try {
                // Trova l'INDICE del piano nei dati locali 'destinations.plannedTrips'
                // È importante lavorare con l'oggetto NELL'ARRAY destinations per mantenere la reattività
                const planIndex = destinations.plannedTrips.findIndex(p => p && p.id && String(p.id).trim() === planIdStr);

                if (planIndex === -1) {
                    console.error(`[JS updatePlanDetails] ERRORE: Piano con ID "${planIdStr}" non trovato in destinations.plannedTrips.`);
                    console.log("[JS updatePlanDetails] Contenuto di destinations.plannedTrips:", JSON.parse(JSON.stringify(destinations.plannedTrips)));
                    showToast('Errore Dati Client', `Piano ID="${planIdStr}" non trovato nei dati client. Ricarica la pagina o riprova.`, 'danger');
                    return;
                }

                // Ottieni il riferimento all'oggetto piano nell'array destinations
                const planObjectFromState = destinations.plannedTrips[planIndex];
                console.log("[JS updatePlanDetails] Oggetto piano recuperato da destinations.plannedTrips (prima delle modifiche dal form):", JSON.parse(JSON.stringify(planObjectFromState)));

                // --- RECUPERO DATI DAL FORM DEL MODAL ---
                const startDateInputEl = document.getElementById('planStartDateInput');
                const endDateInputEl = document.getElementById('planEndDateInput');
                const notesInputEl = document.getElementById('planNotes');

                if (!startDateInputEl || !endDateInputEl || !notesInputEl) {
                    console.error("[JS updatePlanDetails] ERRORE: Uno o più elementi del form (planStartDateInput, planEndDateInput, planNotes) non trovati nel DOM.");
                    showToast('Errore Modulo', 'Campi del form mancanti. Impossibile salvare.', 'danger');
                    return;
                }

                // Leggi i valori CORRENTI dagli elementi del form
                const startDateFromForm = startDateInputEl.value; // Formato YYYY-MM-DD
                const endDateFromForm = endDateInputEl.value;     // Formato YYYY-MM-DD
                const notesFromForm = notesInputEl.value;

                console.log("[JS updatePlanDetails] Valori LETTI DIRETTAMENTE DAL FORM:");
                console.log("  - StartDate (dal form):", startDateFromForm);
                console.log("  - EndDate (dal form):", endDateFromForm);
                console.log("  - Notes (dal form):", notesFromForm);

                // Validazione date
                if (!startDateFromForm || !endDateFromForm) {
                    console.error("[JS updatePlanDetails] ERRORE: Date di inizio o fine mancanti nel form.");
                    showToast('Errore Input', 'Inserisci sia la data di inizio che quella di fine.', 'danger');
                    return;
                }
                // Non è necessario creare oggetti Date qui se il backend si aspetta stringhe YYYY-MM-DD
                // Ma la validazione che startDate non sia dopo endDate è utile:
                if (new Date(startDateFromForm) > new Date(endDateFromForm)) {
                    console.error("[JS updatePlanDetails] ERRORE: Data di inizio successiva a data di fine.");
                    showToast('Errore Input', 'La data di inizio non può essere successiva alla data di fine.', 'danger');
                    return;
                }

                // Prepara l'oggetto checklist da inviare
                // Questa si basa sullo stato corrente di `planObjectFromState.checklist`
                const checklistToSend = (planObjectFromState.checklist || []).map(item => ({
                    id: String(item.id),
                    title: item.title,
                    category: item.category,
                    dueDate: item.dueDate ? formatDateForInput(new Date(item.dueDate)) : null,
                    isCompleted: item.isCompleted
                }));
                console.log("[JS updatePlanDetails] Checklist attuale (dall'oggetto 'planObjectFromState' in memoria) preparata per l'invio:", JSON.parse(JSON.stringify(checklistToSend)));


                // --- Prepara l'oggetto dati da inviare al server ---
                // USA I VALORI LETTI DIRETTAMENTE DAL FORM per date e note
                const updateData = {
                    planId: planObjectFromState.id,      // ID originale del piano (stringa)
                    startDate: startDateFromForm,        // Data letta dal form (stringa YYYY-MM-DD)
                    endDate: endDateFromForm,          // Data letta dal form (stringa YYYY-MM-DD)
                    notes: notesFromForm,              // Note lette dal form
                    checklist: checklistToSend           // Checklist basata sullo stato client-side
                };

                console.log("[JS updatePlanDetails] Dati FINALI pronti per invio al server (con valori dal form):", JSON.stringify(updateData, null, 2));

                if (!updateData.planId || String(updateData.planId).trim() === '') {
                    console.error("[JS updatePlanDetails] ERRORE CRITICO: planId in updateData è nullo o vuoto PRIMA della chiamata fetch!");
                    showToast('Errore Critico JS', 'ID Piano nullo o vuoto prima dell\'invio (JS). Controlla console.', 'danger');
                    return;
                }

                showLoadingOverlay('Salvataggio modifiche in corso...');

                fetch('/DreamMap?handler=UpdatePlanDetails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify(updateData)
                })
                    .then(response => {
                        console.log("[JS updatePlanDetails] Risposta Fetch ricevuta - Status:", response.status, response.statusText);
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error("[JS updatePlanDetails] Errore HTTP dal server:", response.status, text);
                                throw new Error(`Errore server (${response.status}): ${text.substring(0, 250)}...`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        hideLoadingOverlay();
                        console.log("[JS updatePlanDetails] Risposta JSON dal server:", JSON.parse(JSON.stringify(data)));
                        if (data.success) {
                            console.log("[JS updatePlanDetails] Aggiornamento riuscito secondo il server. Messaggio:", data.message);
                            if (data.updatedPlan) {
                                const serverPlan = data.updatedPlan;
                                // Aggiorna l'oggetto planObjectFromState NELL'ARRAY destinations con i dati dal server
                                planObjectFromState.startDate = new Date(serverPlan.startDate);
                                planObjectFromState.endDate = new Date(serverPlan.endDate);
                                planObjectFromState.notes = serverPlan.notes;
                                planObjectFromState.completionPercentage = serverPlan.completionPercentage;
                                planObjectFromState.checklist = (serverPlan.checklist || []).map(serverItem => ({
                                    id: serverItem.id,
                                    title: serverItem.title,
                                    category: serverItem.category,
                                    dueDate: serverItem.dueDate ? new Date(serverItem.dueDate) : null,
                                    isCompleted: serverItem.isCompleted
                                }));
                                console.log("[JS updatePlanDetails] Dati piano NELL'ARRAY 'destinations' aggiornati con risposta server.");
                            } else {
                                console.warn("[JS updatePlanDetails] AVVISO: Risposta server success=true ma 'updatedPlan' mancante. L'aggiornamento locale potrebbe essere incompleto.");
                                // Aggiornamento parziale con dati inviati, se 'updatedPlan' non è presente
                                planObjectFromState.startDate = new Date(startDateFromForm);
                                planObjectFromState.endDate = new Date(endDateFromForm);
                                planObjectFromState.notes = notesFromForm;
                                // La checklist è già lo stato client corrente, ma gli ID potrebbero non essere aggiornati se nuovi.
                                updateCompletionPercentage(planObjectFromState.id); // Ricalcola % basata su questa checklist
                            }

                            sincronizzaStatoApp();

                            const planDateRangeDisplaySpan = document.getElementById('planDateRange')?.querySelector('span');
                            if (planDateRangeDisplaySpan) {
                                planDateRangeDisplaySpan.textContent = `${planObjectFromState.startDate.toLocaleDateString("it-IT")} - ${planObjectFromState.endDate.toLocaleDateString("it-IT")}`;
                            }
                            renderChecklistInModal(planObjectFromState.id);
                            showToast('Successo', data.message || 'Modifiche salvate!', 'success');
                        } else {
                            console.error("[JS updatePlanDetails] Errore logico restituito dal server:", data.message);
                            showToast('Errore Salvataggio', data.message || 'Salvataggio modifiche fallito.', 'danger');
                        }
                    })
                    .catch(error => {
                        hideLoadingOverlay();
                        console.error('[JS updatePlanDetails] Errore CRITICO durante fetch o elaborazione risposta:', error);
                        showToast('Errore Connessione', `Impossibile salvare: ${error.message}`, 'danger');
                    });

            } catch (error) {
                console.error("[JS updatePlanDetails] Eccezione FATALE nel blocco try principale della funzione:", error);
                hideLoadingOverlay();
                showToast('Errore Critico JS', `Errore imprevisto nel JavaScript: ${error.message}`, 'danger');
            }
        }




        function removeChecklistItem(planId, itemId) {
            if (!confirm('Rimuovere elemento checklist?')) return;
            const planIndex = destinations.plannedTrips.findIndex(p => p.id.toString() === planId);
            if (planIndex === -1) { showToast('Errore', 'Piano non trovato.', 'danger'); return; }
            const plan = destinations.plannedTrips[planIndex];
            plan.checklist = plan.checklist.filter(item => item.id.toString() !== itemId.toString());
            renderChecklistInModal(planId);
            updateCompletionPercentage(planId);
            showToast('Info', 'Elemento rimosso. Salva per confermare.', 'info');
        }

        function setupChecklistSubModalSave() {
            const saveBtn = document.getElementById('saveChecklistItemBtn');
            if (saveBtn) {
                saveBtn.onclick = function () {
                    const addModalEl = document.getElementById('addChecklistItemModal');
                    const planId = addModalEl.getAttribute('data-current-plan-id');
                    const title = document.getElementById('checklistItemTitle').value.trim();
                    const category = document.getElementById('checklistItemCategory').value;
                    const dueDate = document.getElementById('checklistItemDueDate').value;

                    if (!title) { showToast('Errore', 'Titolo obbligatorio.', 'danger'); return; }
                    if (!planId) { showToast('Errore', 'ID piano non trovato.', 'danger'); return; }

                    const planIndex = destinations.plannedTrips.findIndex(p => p.id.toString() === planId);
                    if (planIndex === -1) { showToast('Errore', 'Piano non trovato.', 'danger'); return; }
                    const plan = destinations.plannedTrips[planIndex];

                    const newItem = { id: 'client-' + Date.now(), title, category, dueDate: dueDate || null, isCompleted: false };
                    plan.checklist = plan.checklist || [];
                    plan.checklist.push(newItem);

                    renderChecklistInModal(planId);
                    updateCompletionPercentage(planId);
                    bootstrap.Modal.getInstance(addModalEl)?.hide();
                    showToast('Info', 'Elemento aggiunto. Salva per confermare.', 'info');
                };
            }
        }

        function toggleChecklistItem(planId, itemId) {
            const planIndex = destinations.plannedTrips.findIndex(p => p.id.toString() === planId);
            if (planIndex === -1) return;
            const plan = destinations.plannedTrips[planIndex];
            const itemIndex = plan.checklist.findIndex(item => item.id.toString() === itemId.toString());
            if (itemIndex === -1) return;

            plan.checklist[itemIndex].isCompleted = !plan.checklist[itemIndex].isCompleted;

            const listItemElement = document.querySelector(`#planChecklist li[data-id="${itemId}"]`);
            if (listItemElement) {
                listItemElement.classList.toggle('completed', plan.checklist[itemIndex].isCompleted);
                listItemElement.querySelector('i:first-child').className = plan.checklist[itemIndex].isCompleted ? 'fas fa-check-circle' : 'far fa-circle';
            }
            updateCompletionPercentage(planId);
        }

        function showToast(title, message, type = 'info') { // Default type a info
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`; // Bootstrap 5 classes
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `<div class="d-flex"><div class="toast-body"><strong>${title}</strong>: ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 5000, autohide: true });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '1090'; // Higher than modals (Bootstrap modal z-index is 1055)
            document.body.appendChild(container);
            return container;
        }

        function updateCompletionPercentage(planId) {
            const planIndex = destinations.plannedTrips.findIndex(p => p.id.toString() === planId);
            if (planIndex === -1) { console.warn("updateCompletionPercentage: Piano non trovato", planId); return; }
            const plan = destinations.plannedTrips[planIndex];
            plan.checklist = plan.checklist || []; // Assicura che esista

            let percentage = 0;
            if (plan.checklist.length > 0) {
                const completedItemsCount = plan.checklist.filter(item => item.isCompleted).length;
                percentage = Math.round((completedItemsCount / plan.checklist.length) * 100);
            }
            plan.completionPercentage = percentage;

            const planProgressBar = document.getElementById('planProgressBar');
            if (planProgressBar) {
                planProgressBar.style.width = `${percentage}%`;
                planProgressBar.setAttribute('aria-valuenow', percentage);
            }
            const progressPercentageText = document.getElementById('progressPercentage');
            if (progressPercentageText) progressPercentageText.textContent = percentage;

            const sidebarPlanItem = document.querySelector(`.plan-item[data-id="${planId}"] .progress-bar`);
            if (sidebarPlanItem) sidebarPlanItem.style.width = `${percentage}%`;
            const sidebarProgressText = document.querySelector(`.plan-item[data-id="${planId}"] .plan-progress-text`);
            if (sidebarProgressText) sidebarProgressText.textContent = `${percentage}% completato`;
        }

        function moveToPlanningPhase(dreamId) {
            // *** LOG DETTAGLIATO ALL'INGRESSO ***
            console.log('[moveToPlanningPhase] Tentativo di spostamento. ID ricevuto:', dreamId, '(Tipo:', typeof dreamId, ')');

            // Verifica robusta dell'ID
            if (!dreamId || String(dreamId).trim() === '') {
                console.error('[moveToPlanningPhase] Errore: ID nullo, vuoto o non valido ricevuto.');
                showToast('Errore Interno', 'ID Destinazione non valido per lo spostamento.', 'danger');
                return;
            }

            // Normalizza l'ID a stringa per coerenza
            const dreamIdStr = String(dreamId).trim();
            console.log('[moveToPlanningPhase] ID normalizzato a stringa:', dreamIdStr);

            // Verifica opzionale nei dati locali (destinations.wishlist)
            const dreamToMoveLocal = destinations.wishlist.find(dream => dream && dream.id && String(dream.id).trim() === dreamIdStr);
            if (!dreamToMoveLocal) {
                console.warn(`[moveToPlanningPhase] ATTENZIONE: Sogno con ID ${dreamIdStr} non trovato nei dati LOCALI (destinations.wishlist). Ciò potrebbe indicare un problema di sincronizzazione o un ID errato nel DOM.`);
                // Non blocchiamo l'operazione, ma logghiamo l'avviso. Il server ha l'autorità finale.
            } else {
                console.log('[moveToPlanningPhase] Sogno corrispondente trovato nei dati locali:', dreamToMoveLocal);
            }

            showLoadingOverlay('Spostamento in pianificazione...');

            fetch('/DreamMap?handler=MoveToPlanning', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken() // Assicurati che getAntiForgeryToken() funzioni
                },
                // Invia l'ID normalizzato come stringa nel corpo JSON
                body: JSON.stringify({ dreamId: dreamIdStr })
            })
                .then(response => {
                    console.log('[moveToPlanningPhase] Risposta Fetch - Status:', response.status, response.statusText);
                    if (!response.ok) {
                        // Se la risposta non è OK (es. 400, 404, 500), leggi il corpo come testo
                        return response.text().then(text => {
                            console.error('[moveToPlanningPhase] Errore HTTP:', response.status, text);
                            // Crea un errore più descrittivo per il blocco catch
                            throw new Error(`Errore server (${response.status}): ${text.substring(0, 150)}...`);
                        });
                    }
                    // Se la risposta è OK (es. 200), procedi a leggerla come JSON
                    return response.json();
                })
                .then(data => {
                    hideLoadingOverlay();
                    console.log('[moveToPlanningPhase] Risposta JSON dal server:', data);

                    if (data.success) {
                        console.log('[moveToPlanningPhase] Spostamento riuscito secondo il server.');

                        // Chiudi il modal dei dettagli se era aperto
                        const dreamDetailsModalEl = document.getElementById('dreamDetailsModal');
                        if (dreamDetailsModalEl) {
                            const dreamDetailsModal = bootstrap.Modal.getInstance(dreamDetailsModalEl);
                            if (dreamDetailsModal) {
                                dreamDetailsModal.hide();
                                // Rimuovi il backdrop manualmente se necessario dopo la chiusura forzata
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }


                        // Rimuovi l'elemento dalla wishlist locale
                        const initialWishlistLength = destinations.wishlist.length;
                        destinations.wishlist = destinations.wishlist.filter(dream => dream && dream.id && String(dream.id).trim() !== dreamIdStr);
                        console.log(`[moveToPlanningPhase] Wishlist locale aggiornata. Rimossi ${initialWishlistLength - destinations.wishlist.length} elementi.`);

                        // Aggiungi alla pianificazione locale usando i dati *restituiti dal server*
                        const newPlan = data.plannedTrip;
                        if (newPlan && newPlan.id) { // Verifica che il nuovo piano e il suo ID esistano
                            // Assicura che la checklist sia un array nel nuovo oggetto
                            newPlan.checklist = newPlan.checklist || [];
                            // Assicurati che le date siano oggetti Date se necessario (dipende da come le usi dopo)
                            // newPlan.startDate = new Date(newPlan.startDate);
                            // newPlan.endDate = new Date(newPlan.endDate);

                            // Controlla se il piano esiste già (improbabile ma sicuro)
                            const planExists = destinations.plannedTrips.some(p => p && p.id && String(p.id).trim() === String(newPlan.id).trim());
                            if (!planExists) {
                                destinations.plannedTrips.push(newPlan);
                                console.log('[moveToPlanningPhase] Nuovo piano aggiunto ai dati locali:', newPlan);
                            } else {
                                console.warn(`[moveToPlanningPhase] Il piano con ID ${newPlan.id} esisteva già nei dati locali. Non aggiunto di nuovo.`);
                            }

                        } else {
                            console.error('[moveToPlanningPhase] Errore: Spostamento riuscito secondo il server, ma i dati del nuovo piano sono mancanti o incompleti nella risposta!', data);
                            showToast('Errore Dati', 'Errore nel ricevere i dati del nuovo piano.', 'danger');
                            // Nonostante l'errore dati, procedi con la sincronizzazione parziale
                        }

                        sincronizzaStatoApp(); // Aggiorna l'interfaccia utente (sidebar e mappa)
                        document.getElementById('planning-tab')?.click(); // Vai alla tab pianificazione
                        showToast('Successo', `${newPlan?.cityName || 'Destinazione'} spostata in pianificazione!`, 'success');

                    } else {
                        // Mostra il messaggio di errore specifico restituito dal server
                        console.error('[moveToPlanningPhase] Errore logico restituito dal server:', data.message);
                        showToast('Errore Spostamento', data.message || 'Impossibile spostare la destinazione.', 'danger');
                    }
                })
                .catch(error => {
                    hideLoadingOverlay();
                    console.error('[moveToPlanningPhase] Errore durante la chiamata Fetch o elaborazione:', error);
                    // Mostra un messaggio generico o quello dall'errore lanciato nel blocco .then
                    showToast('Errore Connessione', `Impossibile completare lo spostamento: ${error.message}`, 'danger');
                });
        }

        function populateCountryInfo(countryName) {
            const currencyInfoEl = document.getElementById('currencyInfo');
            const languageInfoEl = document.getElementById('languageInfo');
            const timeInfoEl = document.getElementById('timeInfo');
            if (!currencyInfoEl || !languageInfoEl || !timeInfoEl) { console.error('Elementi info paese mancanti.'); return; }

            let currencyText = '', languageText = '', timeText = '';
            switch (countryName) {
                case 'Francia':
                    currencyText = `<p><strong>Euro (€)</strong></p><p>Cambio: ~1 EUR = 1.09 USD</p>`;
                    languageText = `<p><strong>Francese</strong></p><p>Utili: Bonjour, Merci, Au revoir</p>`;
                    timeText = `<p><strong>CET/CEST (UTC+1/UTC+2)</strong></p><p>Stessa ora Italia</p>`;
                    break;
                case 'Giappone':
                    currencyText = `<p><strong>Yen (¥)</strong></p><p>Cambio: ~1 JPY = 0.0067 USD</p>`;
                    languageText = `<p><strong>Giapponese</strong></p><p>Utili: Konnichiwa, Arigatou</p>`;
                    timeText = `<p><strong>JST (UTC+9)</strong></p><p>+7/+8 ore da Italia</p>`;
                    break;
                // Aggiungi altri casi
                default:
                    currencyText = `<p>Info valuta per ${countryName} non disponibile.</p>`;
                    languageText = `<p>Info lingua per ${countryName} non disponibile.</p>`;
                    timeText = `<p>Info fuso orario per ${countryName} non disponibile.</p>`;
            }
            currencyInfoEl.innerHTML = currencyText;
            languageInfoEl.innerHTML = languageText;
            timeInfoEl.innerHTML = timeText;
        }

        function initializeSuggestionTabs() {
            document.querySelectorAll('.suggestion-tab').forEach(tab => {
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
                newTab.addEventListener('click', function () {
                    const targetTab = this.getAttribute('data-tab');
                    if (!targetTab) return;
                    document.querySelectorAll('.suggestion-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.suggestion-pane').forEach(pane => pane.classList.remove('active'));
                    const targetPane = document.querySelector(`.suggestion-pane[data-pane="${targetTab}"]`);
                    if (targetPane) targetPane.classList.add('active');
                });
            });
            document.querySelector('.suggestion-tab[data-tab="attractions"]')?.click(); // Attiva il primo tab
        }

        function removeDream(dreamId) {
            if (!confirm('Rimuovere questa destinazione?')) return;
            showLoadingOverlay('Rimozione...');
            fetch('/DreamMap?handler=RemoveDream', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiForgeryToken() }, body: JSON.stringify({ dreamId })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoadingOverlay();
                    if (data.success) {
                        destinations.wishlist = destinations.wishlist.filter(d => d.id.toString() !== dreamId.toString());
                        sincronizzaStatoApp();
                        showToast('Successo', 'Destinazione rimossa!', 'success');
                    } else { showToast('Errore', data.message || 'Errore rimozione.', 'danger'); }
                })
                .catch(error => { hideLoadingOverlay(); console.error('Errore rimozione:', error); showToast('Errore', 'Errore connessione.', 'danger'); });
        }

        function validateDestinationsData() {
            if (!destinations) destinations = { wishlist: [], plannedTrips: [], visitedCities: [] };
            ['wishlist', 'plannedTrips', 'visitedCities'].forEach(key => {
                if (!destinations[key] || !Array.isArray(destinations[key])) {
                    console.warn(`destinations.${key} non era un array, inizializzato.`);
                    destinations[key] = [];
                }
            });
        }

        function initializeApp() {
            console.log('Initializing WanderGlobe app...');

            // Initialize recommendations
            loadRecommendations('tutte');

            // Set up recommendation tab click handlers
            document.querySelectorAll('#recommendationsTabs button').forEach(button => {
                button.addEventListener('click', function () {
                    document.querySelectorAll('#recommendationsTabs button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    const type = this.getAttribute('data-type');
                    loadRecommendations(type);
                });
            });
            configuraPulsantiModal(); // CHIAMATA CRUCIALE
            setupChecklistSubModalSave();

            const cityDropdown = document.getElementById('WishlistForm_City');
            const countryField = document.getElementById('WishlistForm_Country');
            const countryHiddenField = document.getElementById('Country');
            const countryCodeHiddenField = document.getElementById('CountryCode');

            if (cityDropdown && countryField) {
                cityDropdown.addEventListener('change', function () {
                    const selectedOption = this.options[this.selectedIndex];
                    const country = selectedOption.getAttribute('data-country');
                    const countryCode = selectedOption.getAttribute('data-country-code');
                    countryField.value = country || '';
                    if (countryHiddenField) countryHiddenField.value = country || '';
                    if (countryCodeHiddenField) countryCodeHiddenField.value = countryCode || '';
                });
            }

            validateDestinationsData();
            initMap();
            setupEventListeners();
            setupCityValidation();
            loadMapMarkers();
            sincronizzaStatoApp();
            setupFormHandlers();

            console.log('App initialized successfully');
        }

        function setupCardButtons() {
            // Set up "Add to Wishlist" buttons
            document.querySelectorAll('.recommendation-card .add-to-wishlist').forEach(button => {
                // Clone button to remove any existing event listeners
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function (event) {
                    event.stopPropagation(); // Prevent card click from triggering

                    const recommendationId = this.getAttribute('data-id');
                    console.log('Adding recommendation to wishlist:', recommendationId);

                    if (recommendationId) {
                        // Show loading overlay
                        showLoadingOverlay('Aggiunta alla wishlist...');

                        // Call the add to wishlist function with the ID
                        addToWishlist(recommendationId);
                    } else {
                        showToast('Errore', 'ID destinazione mancante', 'danger');
                    }
                });
            });

            // Set up "Fly to" buttons
            document.querySelectorAll('.recommendation-card .fly-to-btn').forEach(button => {
                // Clone button to remove any existing event listeners
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function (event) {
                    event.stopPropagation(); // Prevent card click from triggering

                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));

                    if (isValidLatitude(lat) && isValidLongitude(lng)) {
                        flyToDestination(lat, lng);
                    } else {
                        showToast('Errore', 'Coordinate non valide', 'danger');
                    }
                });
            });

            // Optional: Add click event on the entire card to show details
            document.querySelectorAll('.recommendation-card').forEach(card => {
                card.addEventListener('click', function () {
                    const recommendationId = this.getAttribute('data-id');
                    if (recommendationId) {
                        // You could add a function to show recommendation details if needed
                        console.log('Showing details for recommendation:', recommendationId);
                        // Could call something like: showRecommendationDetails(recommendationId);
                    }
                });
            });
        }

        function renderRecommendations(recommendations) {
            const container = document.getElementById('recommendationsGrid');
            if (!container) {
                console.error('Recommendations container not found');
                return;
            }

            // Clear existing content
            container.innerHTML = '';

            // Generate HTML for each recommendation
            recommendations.forEach(recommendation => {
                const cardElement = document.createElement('div');
                cardElement.className = 'recommendation-card';
                cardElement.dataset.id = recommendation.id;

                // Format recommendation image with fallback
                const imageUrl = recommendation.imageUrl || '/images/placeholder-destination.jpg';
                const countryCode = recommendation.countryCode ? recommendation.countryCode.toLowerCase() : 'unknown';

                // Create recommendation card HTML
                cardElement.innerHTML = `
                            <div class="recommendation-image">
                                <img src="${imageUrl}" alt="${recommendation.cityName}"
                                    onerror="this.src='/images/placeholder-destination.jpg'">
                                ${recommendation.isAiGenerated ? '<span class="ai-badge">AI Pick</span>' : ''}
                            </div>
                            <div class="recommendation-content">
                                <h3 class="recommendation-title">${recommendation.cityName}</h3>
                                <h4 class="recommendation-subtitle">${recommendation.countryName}</h4>
                                <p class="recommendation-description">${recommendation.description || 'Explore this beautiful destination'}</p>
                                <div class="recommendation-reason">
                                    <i class="fas fa-star me-1"></i>
                                    <span>${recommendation.reasonToVisit || `${recommendation.matchPercentage || 95}% match with your preferences`}</span>
                                </div>
                            </div>
                            <div class="recommendation-actions">
                                <button class="btn btn-primary add-to-wishlist" data-id="${recommendation.id}"
                                        data-city="${recommendation.cityName}" data-country="${recommendation.countryName}"
                                        data-lat="${recommendation.latitude}" data-lng="${recommendation.longitude}">
                                    <i class="fas fa-heart me-1"></i> Aggiungere
                                </button>
                                <button class="btn btn-outline-secondary fly-to-btn" data-lat="${recommendation.latitude}"
                                        data-lng="${recommendation.longitude}">
                                    <i class="fas fa-map-marker-alt me-1"></i> Mostra
                                </button>
                            </div>
                        `;

                container.appendChild(cardElement);
            });

            // Set up the buttons on the cards
            setupCardButtons();
        }

        function loadRecommendations(type) {
    console.log(`Loading recommendations of type: ${type}`);

    // Show loading state
    const container = document.getElementById('recommendationsGrid');
    const loadingElement = document.getElementById('recommendationsLoading');
    const emptyElement = document.getElementById('recommendationsEmpty');
    const errorElement = document.getElementById('recommendationsError');

    console.log('Found container:', container);
    console.log('Found loadingElement:', loadingElement);
    console.log('Found emptyElement:', emptyElement);
    console.log('Found errorElement:', errorElement);

    if (container) container.style.display = 'none';
    if (loadingElement) loadingElement.style.display = 'flex';
    if (emptyElement) emptyElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';

    // Make API call to get recommendations
    fetch(`/DreamMap?handler=Recommendations&type=${encodeURIComponent(type)}`, {
        headers: {
            'RequestVerificationToken': getAntiForgeryToken()
        }
    })
    .then(response => {
        console.log(`Response status: ${response.status}`); // Log the response status
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data); // Log the entire data object
        if (loadingElement) loadingElement.style.display = 'none';

        if (data.success) {
            // If we have recommendations, render them
            if (data.recommendations && data.recommendations.length > 0) {
                console.log('Recommendations received:', data.recommendations); // Log the recommendations array

                renderRecommendations(data.recommendations);
                if (container) container.style.display = 'grid';
            } else {
                // Show empty state if no recommendations
                console.warn('No recommendations received.');
                if (emptyElement) emptyElement.style.display = 'flex';
            }
        } else {
            // Show error message
            console.error('Error loading recommendations:', data.message);
            if (errorElement) {
                errorElement.style.display = 'flex';
                const errorMsg = errorElement.querySelector('p');
                if (errorMsg) errorMsg.textContent = data.message || 'Error loading recommendations';
            }
        }
    })
    .catch(error => {
        console.error('Failed to load recommendations:', error);
        if (loadingElement) loadingElement.style.display = 'none';
        if (errorElement) errorElement.style.display = 'flex';
    });
}

        function setupCityValidation() {
            const submitButton = document.querySelector('#dreamForm button[type="submit"]');
            const cityField = document.getElementById('WishlistForm_City');
            if (submitButton && cityField) {
                submitButton.addEventListener('click', function (e) {
                    if (!cityField.value) { e.preventDefault(); showToast('Errore', 'Seleziona una città.', 'danger'); return false; }
                });
            }
            const form = document.getElementById('dreamForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    if (!cityField.value) { e.preventDefault(); showToast('Errore', 'Seleziona una città.', 'danger'); return false; }
                });
            }
        }

        function setupFormHandlers() {
            const dreamForm = document.getElementById('dreamForm');
            if (dreamForm) {
                dreamForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    showLoadingOverlay('Salvataggio...');
                    const formData = new FormData(dreamForm);
                    // Il token viene aggiunto automaticamente se il campo hidden è nel form, ma per fetch è meglio esplicitarlo
                    fetch('/DreamMap?handler=SaveToWishlist', {
                        method: 'POST', body: formData, headers: { 'RequestVerificationToken': getAntiForgeryToken() }
                    })
                        .then(response => response.json())
                        .then(data => {
                            hideLoadingOverlay();
                            if (data.success) {
                                if (!destinations.wishlist) destinations.wishlist = [];
                                destinations.wishlist.push(data.newItem);
                                sincronizzaStatoApp();
                                bootstrap.Modal.getInstance(document.getElementById('addDreamModal'))?.hide();
                                dreamForm.reset(); // Resetta i campi del form
                                document.getElementById('WishlistForm_Country').value = ''; // Pulisci campo paese readonly
                                showToast('Successo', 'Destinazione aggiunta!', 'success');
                            } else { showToast('Errore', data.message || 'Salvataggio fallito.', 'danger'); }
                        })
                        .catch(error => { hideLoadingOverlay(); console.error('Errore submit form:', error); showToast('Errore', `Errore salvataggio: ${error.message}`, 'danger'); });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
}